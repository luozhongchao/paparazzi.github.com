<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Paparazzi UAS: sw/airborne/arch/stm32/mcu_periph/spi_arch.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  <td id="projectlogo"><img alt="Logo" src="penguin_icon.png"/></td>
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Paparazzi UAS
   &#160;<span id="projectnumber">v4.9_devel-358-gfb636ac</span>
   </div>
   <div id="projectbrief">Paparazzi is a free software Unmanned Aircraft System.</div>
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="dynsections.js"></script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('stm32_2mcu__periph_2spi__arch_8c.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">spi_arch.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="stm32_2mcu__periph_2spi__arch_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (C) 2005-2012 The Paparazzi Team</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This file is part of paparazzi.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * paparazzi is free software; you can redistribute it and/or modify</span>
<a name="l00007"></a>00007 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
<a name="l00008"></a>00008 <span class="comment"> * the Free Software Foundation; either version 2, or (at your option)</span>
<a name="l00009"></a>00009 <span class="comment"> * any later version.</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * paparazzi is distributed in the hope that it will be useful,</span>
<a name="l00012"></a>00012 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00013"></a>00013 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00014"></a>00014 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00017"></a>00017 <span class="comment"> * along with paparazzi; see the file COPYING.  If not, write to</span>
<a name="l00018"></a>00018 <span class="comment"> * the Free Software Foundation, 59 Temple Place - Suite 330,</span>
<a name="l00019"></a>00019 <span class="comment"> * Boston, MA 02111-1307, USA.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> */</span>
<a name="l00022"></a>00022 
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;libopencm3/stm32/f1/nvic.h&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;libopencm3/stm32/f1/gpio.h&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;libopencm3/stm32/f1/rcc.h&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;libopencm3/stm32/exti.h&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;libopencm3/stm32/spi.h&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;libopencm3/stm32/f1/dma.h&gt;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="spi_8h.html" title="Architecture independent SPI (Serial Peripheral Interface) API.">mcu_periph/spi.h</a>&quot;</span>
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="preprocessor">#ifdef SPI_MASTER</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span>
<a name="l00055"></a>00055 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#aa2be57519fcaa1b2795cdd27016ff696">spi_rw</a>(<span class="keyword">struct</span> <a class="code" href="structspi__periph.html">spi_periph</a>* <a class="code" href="ins__alt__float_8c.html#a9d3f100c4375da4d957dbe599d494905">p</a>, <span class="keyword">struct</span> <a class="code" href="structspi__transaction.html" title="SPI transaction structure.">spi_transaction</a>  * _trans);
<a name="l00056"></a>00056 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a0691bd5fba1792e012d73c002cb44a95" title="Processing done after rx completes.">process_rx_dma_interrupt</a>( <span class="keyword">struct</span> <a class="code" href="structspi__periph.html">spi_periph</a> *spi );
<a name="l00057"></a>00057 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a28927664346f77a7fc1aeb8994b7869c" title="Processing done after tx completes.">process_tx_dma_interrupt</a>( <span class="keyword">struct</span> <a class="code" href="structspi__periph.html">spi_periph</a> *spi );
<a name="l00058"></a>00058 
<a name="l00063"></a><a class="code" href="structspi__periph__dma.html">00063</a> <span class="keyword">struct </span><a class="code" href="structspi__periph__dma.html" title="This structure keeps track of specific ID&#39;s for each SPI bus, which allows for more code reuse...">spi_periph_dma</a> {
<a name="l00064"></a><a class="code" href="structspi__periph__dma.html#aa38bcf805c46baa4d49f4ace89cfed57">00064</a>   u32 <a class="code" href="structspi__periph__dma.html#aa38bcf805c46baa4d49f4ace89cfed57">spi</a>;
<a name="l00065"></a><a class="code" href="structspi__periph__dma.html#aa2f4122476bc251c47e2d2eca91f296e">00065</a>   u32 <a class="code" href="structspi__periph__dma.html#aa2f4122476bc251c47e2d2eca91f296e">spidr</a>;
<a name="l00066"></a><a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">00066</a>   u32 <a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>;
<a name="l00067"></a><a class="code" href="structspi__periph__dma.html#aefcd5ba30da5eaf93f6d3e0a29ee9467">00067</a>   u8  <a class="code" href="structspi__periph__dma.html#aefcd5ba30da5eaf93f6d3e0a29ee9467">rx_chan</a>;
<a name="l00068"></a><a class="code" href="structspi__periph__dma.html#aff566f47d98f3f04370908401ad6c47d">00068</a>   u8  <a class="code" href="structspi__periph__dma.html#aff566f47d98f3f04370908401ad6c47d">tx_chan</a>;
<a name="l00069"></a><a class="code" href="structspi__periph__dma.html#a9a689b71e186b6ceee15cc0e94f621d2">00069</a>   u8  <a class="code" href="structspi__periph__dma.html#a9a689b71e186b6ceee15cc0e94f621d2">nvic_irq</a>;
<a name="l00070"></a><a class="code" href="structspi__periph__dma.html#a82c273595bab7bef077bd999a3a24f1f">00070</a>   u32 <a class="code" href="structspi__periph__dma.html#a82c273595bab7bef077bd999a3a24f1f">cdiv</a>;
<a name="l00071"></a><a class="code" href="structspi__periph__dma.html#a45a21a79c2eef245ad0fd0889fd5e0a4">00071</a>   u32 <a class="code" href="structspi__periph__dma.html#a45a21a79c2eef245ad0fd0889fd5e0a4">cpol</a>;
<a name="l00072"></a><a class="code" href="structspi__periph__dma.html#a5764478239bc4fa5aa4a37d690dfe392">00072</a>   u32 <a class="code" href="structspi__periph__dma.html#a5764478239bc4fa5aa4a37d690dfe392">cpha</a>;
<a name="l00073"></a><a class="code" href="structspi__periph__dma.html#a94a24ec6125f696b505ecfb97352732b">00073</a>   u32 <a class="code" href="structspi__periph__dma.html#a94a24ec6125f696b505ecfb97352732b">dss</a>;
<a name="l00074"></a><a class="code" href="structspi__periph__dma.html#a6956aff142bd54afdb5a60540c939b59">00074</a>   u32 <a class="code" href="structspi__periph__dma.html#a6956aff142bd54afdb5a60540c939b59">bo</a>;
<a name="l00075"></a><a class="code" href="structspi__periph__dma.html#a63a1d0e3e71a13741454f9d4bec52145">00075</a>   u8  <a class="code" href="structspi__periph__dma.html#a63a1d0e3e71a13741454f9d4bec52145">config</a>;
<a name="l00076"></a>00076 };
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="preprocessor">#if USE_SPI0</span>
<a name="l00079"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a7d8ebbd3680a7fc3e33eaf638f396c18">00079</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structspi__periph__dma.html" title="This structure keeps track of specific ID&#39;s for each SPI bus, which allows for more code reuse...">spi_periph_dma</a> <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a7d8ebbd3680a7fc3e33eaf638f396c18">spi0_dma</a>;
<a name="l00080"></a>00080 <span class="preprocessor">#endif</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span><span class="preprocessor">#if USE_SPI1</span>
<a name="l00082"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a1fcd46a62bab151ce1f91b72cdbe3568">00082</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structspi__periph__dma.html" title="This structure keeps track of specific ID&#39;s for each SPI bus, which allows for more code reuse...">spi_periph_dma</a> <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a1fcd46a62bab151ce1f91b72cdbe3568">spi1_dma</a>;
<a name="l00083"></a>00083 <span class="preprocessor">#endif</span>
<a name="l00084"></a>00084 <span class="preprocessor"></span><span class="preprocessor">#if USE_SPI2</span>
<a name="l00085"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a3ef76c50f4063e0bd8f6ad418ceb8d59">00085</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structspi__periph__dma.html" title="This structure keeps track of specific ID&#39;s for each SPI bus, which allows for more code reuse...">spi_periph_dma</a> <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a3ef76c50f4063e0bd8f6ad418ceb8d59">spi2_dma</a>;
<a name="l00086"></a>00086 <span class="preprocessor">#endif</span>
<a name="l00087"></a>00087 <span class="preprocessor"></span>
<a name="l00088"></a>00088 <span class="comment">// SPI2 Slave Selection</span>
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 <span class="comment">// This mapping is related to the mapping of spi(x) structures in the modules and not</span>
<a name="l00091"></a>00091 <span class="comment">// necessarily to the identifiers as they appear to the processor.</span>
<a name="l00092"></a>00092 <span class="comment">// The IMU on Lisam2 for example is assigned to the SPI2 bus, but we continue to use</span>
<a name="l00093"></a>00093 <span class="comment">// the mapping to spi(x) structures as in modules here. The actual mapping of pins</span>
<a name="l00094"></a>00094 <span class="comment">// occurs in &quot;arch_init&quot;.</span>
<a name="l00095"></a>00095 <span class="comment">// What this means is that we&#39;re effectively &#39;locking&#39;:</span>
<a name="l00096"></a>00096 <span class="comment">// SPI2 to spi2</span>
<a name="l00097"></a>00097 <span class="comment">// SPI1 to spi1</span>
<a name="l00098"></a>00098 <span class="comment">// SPI3 to spi0</span>
<a name="l00099"></a>00099 
<a name="l00100"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a36b52cd82ac80095040ec2ceefef4f70">00100</a> <span class="preprocessor">#define SPI_SELECT_SLAVE0_PERIPH RCC_APB2ENR_IOPAEN</span>
<a name="l00101"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a62cb06db3908015c7305ca6833f90159">00101</a> <span class="preprocessor"></span><span class="preprocessor">#define SPI_SELECT_SLAVE0_PORT GPIOA</span>
<a name="l00102"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a697b8e633c428bd167844542c8c1453f">00102</a> <span class="preprocessor"></span><span class="preprocessor">#define SPI_SELECT_SLAVE0_PIN GPIO15</span>
<a name="l00103"></a>00103 <span class="preprocessor"></span>
<a name="l00104"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a59bc6942e52ff561a9cfffffb30e00a2">00104</a> <span class="preprocessor">#define SPI_SELECT_SLAVE1_PERIPH RCC_APB2ENR_IOPAEN</span>
<a name="l00105"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#abed465f8e9387dc4c034b1d71989043c">00105</a> <span class="preprocessor"></span><span class="preprocessor">#define SPI_SELECT_SLAVE1_PORT GPIOA</span>
<a name="l00106"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a6391f9c6d48eca04803022ab073df01a">00106</a> <span class="preprocessor"></span><span class="preprocessor">#define SPI_SELECT_SLAVE1_PIN GPIO4</span>
<a name="l00107"></a>00107 <span class="preprocessor"></span>
<a name="l00108"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#adc10ae70ef3323f58bbeb2e26b356ba3">00108</a> <span class="preprocessor">#define SPI_SELECT_SLAVE2_PERIPH RCC_APB2ENR_IOPBEN</span>
<a name="l00109"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#ad1fce2206d522b24623e9b742b1f2988">00109</a> <span class="preprocessor"></span><span class="preprocessor">#define SPI_SELECT_SLAVE2_PORT GPIOB</span>
<a name="l00110"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#ae006e4c20f82ac5d2104debcd8615f06">00110</a> <span class="preprocessor"></span><span class="preprocessor">#define SPI_SELECT_SLAVE2_PIN GPIO12</span>
<a name="l00111"></a>00111 <span class="preprocessor"></span>
<a name="l00112"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a85be689297fe8683500c740f75d5bf90">00112</a> <span class="preprocessor">#define SPI_SELECT_SLAVE3_PERIPH RCC_APB2ENR_IOPCEN</span>
<a name="l00113"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#aaf1f83e1cd34b94de35fbbaaa7f6cb46">00113</a> <span class="preprocessor"></span><span class="preprocessor">#define SPI_SELECT_SLAVE3_PORT GPIOC</span>
<a name="l00114"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a43f488034394a3e0c0749b96fdbdd08f">00114</a> <span class="preprocessor"></span><span class="preprocessor">#define SPI_SELECT_SLAVE3_PIN GPIO13</span>
<a name="l00115"></a>00115 <span class="preprocessor"></span>
<a name="l00116"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#ad032b13900d3d088a3f1e8cc1a7cc852">00116</a> <span class="preprocessor">#define SPI_SELECT_SLAVE4_PERIPH RCC_APB2ENR_IOPCEN</span>
<a name="l00117"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a68d301edae4fbbd1f4a7e9de1a9252b1">00117</a> <span class="preprocessor"></span><span class="preprocessor">#define SPI_SELECT_SLAVE4_PORT GPIOC</span>
<a name="l00118"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#aaaf3b422873946314dfec6703a3a5580">00118</a> <span class="preprocessor"></span><span class="preprocessor">#define SPI_SELECT_SLAVE4_PIN GPIO12</span>
<a name="l00119"></a>00119 <span class="preprocessor"></span>
<a name="l00120"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#af3a0a783f898c0211f2c0e5498c746a0">00120</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#af3a0a783f898c0211f2c0e5498c746a0">SpiSlaveUnselect</a>(<a class="code" href="types_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> slave)
<a name="l00121"></a>00121 {
<a name="l00122"></a>00122   <span class="keywordflow">switch</span>(slave) {
<a name="l00123"></a>00123 <span class="preprocessor">#if USE_SPI_SLAVE0</span>
<a name="l00124"></a>00124 <span class="preprocessor"></span>    <span class="keywordflow">case</span> 0:
<a name="l00125"></a>00125       GPIO_BSRR(<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a62cb06db3908015c7305ca6833f90159">SPI_SELECT_SLAVE0_PORT</a>) = <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a697b8e633c428bd167844542c8c1453f">SPI_SELECT_SLAVE0_PIN</a>;
<a name="l00126"></a>00126       <span class="keywordflow">break</span>;
<a name="l00127"></a>00127 <span class="preprocessor">#endif // USE_SPI_SLAVE0</span>
<a name="l00128"></a>00128 <span class="preprocessor"></span><span class="preprocessor">#if USE_SPI_SLAVE1</span>
<a name="l00129"></a>00129 <span class="preprocessor"></span>    <span class="keywordflow">case</span> 1:
<a name="l00130"></a>00130       GPIO_BSRR(<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#abed465f8e9387dc4c034b1d71989043c">SPI_SELECT_SLAVE1_PORT</a>) = <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a6391f9c6d48eca04803022ab073df01a">SPI_SELECT_SLAVE1_PIN</a>;
<a name="l00131"></a>00131       <span class="keywordflow">break</span>;
<a name="l00132"></a>00132 <span class="preprocessor">#endif //USE_SPI_SLAVE1</span>
<a name="l00133"></a>00133 <span class="preprocessor"></span><span class="preprocessor">#if USE_SPI_SLAVE2</span>
<a name="l00134"></a>00134 <span class="preprocessor"></span>    <span class="keywordflow">case</span> 2:
<a name="l00135"></a>00135       GPIO_BSRR(<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#ad1fce2206d522b24623e9b742b1f2988">SPI_SELECT_SLAVE2_PORT</a>) = <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#ae006e4c20f82ac5d2104debcd8615f06">SPI_SELECT_SLAVE2_PIN</a>;
<a name="l00136"></a>00136       <span class="keywordflow">break</span>;
<a name="l00137"></a>00137 <span class="preprocessor">#endif //USE_SPI_SLAVE2</span>
<a name="l00138"></a>00138 <span class="preprocessor"></span><span class="preprocessor">#if USE_SPI_SLAVE3</span>
<a name="l00139"></a>00139 <span class="preprocessor"></span>    <span class="keywordflow">case</span> 3:
<a name="l00140"></a>00140       GPIO_BSRR(<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#aaf1f83e1cd34b94de35fbbaaa7f6cb46">SPI_SELECT_SLAVE3_PORT</a>) = <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a43f488034394a3e0c0749b96fdbdd08f">SPI_SELECT_SLAVE3_PIN</a>;
<a name="l00141"></a>00141       <span class="keywordflow">break</span>;
<a name="l00142"></a>00142 <span class="preprocessor">#endif //USE_SPI_SLAVE3</span>
<a name="l00143"></a>00143 <span class="preprocessor"></span><span class="preprocessor">#if USE_SPI_SLAVE4</span>
<a name="l00144"></a>00144 <span class="preprocessor"></span>    <span class="keywordflow">case</span> 4:
<a name="l00145"></a>00145       GPIO_BSRR(<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a68d301edae4fbbd1f4a7e9de1a9252b1">SPI_SELECT_SLAVE4_PORT</a>) = <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#aaaf3b422873946314dfec6703a3a5580">SPI_SELECT_SLAVE4_PIN</a>;
<a name="l00146"></a>00146       <span class="keywordflow">break</span>;
<a name="l00147"></a>00147 <span class="preprocessor">#endif //USE_SPI_SLAVE4</span>
<a name="l00148"></a>00148 <span class="preprocessor"></span>    <span class="keywordflow">default</span>:
<a name="l00149"></a>00149       <span class="keywordflow">break</span>;
<a name="l00150"></a>00150   }
<a name="l00151"></a>00151 }
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 
<a name="l00154"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#ab639bd461acc9159f2a8566bfe1ebdd0">00154</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#ab639bd461acc9159f2a8566bfe1ebdd0">SpiSlaveSelect</a>(<a class="code" href="types_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> slave)
<a name="l00155"></a>00155 {
<a name="l00156"></a>00156   <span class="keywordflow">switch</span>(slave) {
<a name="l00157"></a>00157 <span class="preprocessor">#if USE_SPI_SLAVE0</span>
<a name="l00158"></a>00158 <span class="preprocessor"></span>    <span class="keywordflow">case</span> 0:
<a name="l00159"></a>00159       GPIO_BRR(<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a62cb06db3908015c7305ca6833f90159">SPI_SELECT_SLAVE0_PORT</a>) = <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a697b8e633c428bd167844542c8c1453f">SPI_SELECT_SLAVE0_PIN</a>;
<a name="l00160"></a>00160       <span class="keywordflow">break</span>;
<a name="l00161"></a>00161 <span class="preprocessor">#endif // USE_SPI_SLAVE0</span>
<a name="l00162"></a>00162 <span class="preprocessor"></span><span class="preprocessor">#if USE_SPI_SLAVE1</span>
<a name="l00163"></a>00163 <span class="preprocessor"></span>    <span class="keywordflow">case</span> 1:
<a name="l00164"></a>00164       GPIO_BRR(<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#abed465f8e9387dc4c034b1d71989043c">SPI_SELECT_SLAVE1_PORT</a>) = <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a6391f9c6d48eca04803022ab073df01a">SPI_SELECT_SLAVE1_PIN</a>;
<a name="l00165"></a>00165       <span class="keywordflow">break</span>;
<a name="l00166"></a>00166 <span class="preprocessor">#endif //USE_SPI_SLAVE1</span>
<a name="l00167"></a>00167 <span class="preprocessor"></span><span class="preprocessor">#if USE_SPI_SLAVE2</span>
<a name="l00168"></a>00168 <span class="preprocessor"></span>    <span class="keywordflow">case</span> 2:
<a name="l00169"></a>00169       GPIO_BRR(<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#ad1fce2206d522b24623e9b742b1f2988">SPI_SELECT_SLAVE2_PORT</a>) = <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#ae006e4c20f82ac5d2104debcd8615f06">SPI_SELECT_SLAVE2_PIN</a>;
<a name="l00170"></a>00170       <span class="keywordflow">break</span>;
<a name="l00171"></a>00171 <span class="preprocessor">#endif //USE_SPI_SLAVE2</span>
<a name="l00172"></a>00172 <span class="preprocessor"></span><span class="preprocessor">#if USE_SPI_SLAVE3</span>
<a name="l00173"></a>00173 <span class="preprocessor"></span>    <span class="keywordflow">case</span> 3:
<a name="l00174"></a>00174       GPIO_BRR(<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#aaf1f83e1cd34b94de35fbbaaa7f6cb46">SPI_SELECT_SLAVE3_PORT</a>) = <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a43f488034394a3e0c0749b96fdbdd08f">SPI_SELECT_SLAVE3_PIN</a>;
<a name="l00175"></a>00175       <span class="keywordflow">break</span>;
<a name="l00176"></a>00176 <span class="preprocessor">#endif //USE_SPI_SLAVE3</span>
<a name="l00177"></a>00177 <span class="preprocessor"></span><span class="preprocessor">#if USE_SPI_SLAVE4</span>
<a name="l00178"></a>00178 <span class="preprocessor"></span>    <span class="keywordflow">case</span> 4:
<a name="l00179"></a>00179       GPIO_BRR(<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a68d301edae4fbbd1f4a7e9de1a9252b1">SPI_SELECT_SLAVE4_PORT</a>) = <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#aaaf3b422873946314dfec6703a3a5580">SPI_SELECT_SLAVE4_PIN</a>;
<a name="l00180"></a>00180       <span class="keywordflow">break</span>;
<a name="l00181"></a>00181 <span class="preprocessor">#endif //USE_SPI_SLAVE3</span>
<a name="l00182"></a>00182 <span class="preprocessor"></span>    <span class="keywordflow">default</span>:
<a name="l00183"></a>00183       <span class="keywordflow">break</span>;
<a name="l00184"></a>00184   }
<a name="l00185"></a>00185 }
<a name="l00186"></a>00186 
<a name="l00188"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a92d285e5b860130426aa3ce1369df0c9">00188</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a92d285e5b860130426aa3ce1369df0c9" title="Enable DMA rx channel interrupt.">spi_arch_int_enable</a>( <span class="keyword">struct</span> <a class="code" href="structspi__periph.html">spi_periph</a> *<a class="code" href="structspi__periph__dma.html#aa38bcf805c46baa4d49f4ace89cfed57">spi</a> ) {
<a name="l00189"></a>00189   nvic_set_priority( ((<span class="keyword">struct</span> <a class="code" href="structspi__periph__dma.html" title="This structure keeps track of specific ID&#39;s for each SPI bus, which allows for more code reuse...">spi_periph_dma</a> *)spi-&gt;<a class="code" href="structspi__periph.html#a8b32489ec5498094c97fd4d31209ab47">init_struct</a>)-&gt;nvic_irq, 0);
<a name="l00190"></a>00190   nvic_enable_irq( ((<span class="keyword">struct</span> <a class="code" href="structspi__periph__dma.html" title="This structure keeps track of specific ID&#39;s for each SPI bus, which allows for more code reuse...">spi_periph_dma</a> *)spi-&gt;<a class="code" href="structspi__periph.html#a8b32489ec5498094c97fd4d31209ab47">init_struct</a>)-&gt;nvic_irq );
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00194"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a42f17f52b327c1192801fc39493f43c5">00194</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a42f17f52b327c1192801fc39493f43c5" title="Disable DMA rx channel interrupt.">spi_arch_int_disable</a>( <span class="keyword">struct</span> <a class="code" href="structspi__periph.html">spi_periph</a> *<a class="code" href="structspi__periph__dma.html#aa38bcf805c46baa4d49f4ace89cfed57">spi</a> ) {
<a name="l00195"></a>00195   nvic_disable_irq( ((<span class="keyword">struct</span> <a class="code" href="structspi__periph__dma.html" title="This structure keeps track of specific ID&#39;s for each SPI bus, which allows for more code reuse...">spi_periph_dma</a> *)spi-&gt;<a class="code" href="structspi__periph.html#a8b32489ec5498094c97fd4d31209ab47">init_struct</a>)-&gt;nvic_irq );
<a name="l00196"></a>00196 }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 <span class="comment">/*</span>
<a name="l00199"></a>00199 <span class="comment"> *  These functions map the publically available &quot;spi&quot; structures to</span>
<a name="l00200"></a>00200 <span class="comment"> *  specific pins on this processor</span>
<a name="l00201"></a>00201 <span class="comment"> */</span>
<a name="l00202"></a>00202 <span class="preprocessor">#if USE_SPI0</span>
<a name="l00203"></a><a class="code" href="group__spi.html#gab8cb9f918fae47c201bf233a0b3b282f">00203</a> <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="group__spi.html#gab8cb9f918fae47c201bf233a0b3b282f" title="Architecture dependant SPI0 initialization.">spi0_arch_init</a>(<span class="keywordtype">void</span>) {
<a name="l00204"></a>00204 
<a name="l00205"></a>00205   <span class="comment">// Enable SPI3 Periph and gpio clocks -------------------------------------------------</span>
<a name="l00206"></a>00206   rcc_peripheral_enable_clock(&amp;RCC_APB1ENR, RCC_APB1ENR_SPI3EN);
<a name="l00207"></a>00207 
<a name="l00208"></a>00208   <span class="comment">// Configure GPIOs: SCK, MISO and MOSI  --------------------------------</span>
<a name="l00209"></a>00209   gpio_set_mode(GPIO_BANK_SPI3_SCK, GPIO_MODE_OUTPUT_50_MHZ,
<a name="l00210"></a>00210             GPIO_CNF_OUTPUT_ALTFN_PUSHPULL, GPIO_SPI3_SCK |
<a name="l00211"></a>00211                                             GPIO_SPI3_MOSI);
<a name="l00212"></a>00212 
<a name="l00213"></a>00213   gpio_set_mode(GPIO_BANK_SPI3_MISO, GPIO_MODE_INPUT, GPIO_CNF_INPUT_FLOAT,
<a name="l00214"></a>00214           GPIO_SPI3_MISO);
<a name="l00215"></a>00215 
<a name="l00216"></a>00216   <span class="comment">// reset SPI</span>
<a name="l00217"></a>00217   spi_reset(SPI3);
<a name="l00218"></a>00218 
<a name="l00219"></a>00219   <span class="comment">// Disable SPI peripheral</span>
<a name="l00220"></a>00220   spi_disable(SPI3);
<a name="l00221"></a>00221 
<a name="l00222"></a>00222   <span class="comment">// Initialize the slave select pins</span>
<a name="l00223"></a>00223   <span class="comment">// done from mcu_init, is it really necessary to do that here?</span>
<a name="l00224"></a>00224   <span class="comment">//spi_init_slaves();</span>
<a name="l00225"></a>00225 
<a name="l00226"></a>00226   <span class="comment">// rcc_peripheral_enable_clock(&amp;RCC_AHBENR, RCC_AHBENR_OTGFSEN);</span>
<a name="l00227"></a>00227 
<a name="l00228"></a>00228   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a7d8ebbd3680a7fc3e33eaf638f396c18">spi0_dma</a>.<a class="code" href="structspi__periph__dma.html#a63a1d0e3e71a13741454f9d4bec52145">config</a> = (<a class="code" href="group__spi.html#ggab7f6befabf036cdd2fcc73e688d17f92a616ab1558f18f3b3c58f22e0f16fe40e">SPIDss8bit</a> &lt;&lt; 6) | (<a class="code" href="group__spi.html#ggaaabe4f085d398b1dabe6526437d0069baedf1306791ecf55a11a2a37dbbd6b1b1">SPIDiv64</a> &lt;&lt; 3) | (<a class="code" href="group__spi.html#ggaa97b351a297dda534c3f9cee0d5b4647ab95f234ab8475459a286da0c132240e9">SPIMSBFirst</a> &lt;&lt; 2) | (<a class="code" href="group__spi.html#gga133152bd9fd803ef729bdfb9dc488baaa0819b3eda26f2666ff69ced98db281ce">SPICphaEdge2</a> &lt;&lt; 1) | (<a class="code" href="group__spi.html#gga585d188d86d5ad9a6fe2d3d11af58ca7abb9d597cb05133176eac7d6a87b5f9af">SPICpolIdleHigh</a>);
<a name="l00229"></a>00229 
<a name="l00230"></a>00230   <span class="comment">// Force SPI mode over I2S.</span>
<a name="l00231"></a>00231   SPI3_I2SCFGR = 0;
<a name="l00232"></a>00232 
<a name="l00233"></a>00233   <span class="comment">// configure master SPI.</span>
<a name="l00234"></a>00234   spi_init_master(SPI3, SPI_CR1_BAUDRATE_FPCLK_DIV_64, SPI_CR1_CPOL_CLK_TO_1_WHEN_IDLE,
<a name="l00235"></a>00235                   SPI_CR1_CPHA_CLK_TRANSITION_2, SPI_CR1_DFF_8BIT, SPI_CR1_MSBFIRST);
<a name="l00236"></a>00236 
<a name="l00237"></a>00237   <span class="comment">/*</span>
<a name="l00238"></a>00238 <span class="comment">   * Set NSS management to software.</span>
<a name="l00239"></a>00239 <span class="comment">   *</span>
<a name="l00240"></a>00240 <span class="comment">   * Note:</span>
<a name="l00241"></a>00241 <span class="comment">   * Setting nss high is very important, even if we are controlling the GPIO</span>
<a name="l00242"></a>00242 <span class="comment">   * ourselves this bit needs to be at least set to 1, otherwise the spi</span>
<a name="l00243"></a>00243 <span class="comment">   * peripheral will not send any data out.</span>
<a name="l00244"></a>00244 <span class="comment">   */</span>
<a name="l00245"></a>00245   spi_enable_software_slave_management(SPI3);
<a name="l00246"></a>00246   spi_set_nss_high(SPI3);
<a name="l00247"></a>00247 
<a name="l00248"></a>00248   <span class="comment">// Enable SPI_3 DMA clock ---------------------------------------------------</span>
<a name="l00249"></a>00249   rcc_peripheral_enable_clock(&amp;RCC_AHBENR, RCC_AHBENR_DMA2EN);
<a name="l00250"></a>00250 
<a name="l00251"></a>00251   <span class="comment">// Enable SPI3 periph.</span>
<a name="l00252"></a>00252   spi_enable(SPI3);
<a name="l00253"></a>00253 
<a name="l00254"></a>00254   <a class="code" href="group__spi.html#gae920399b05f855df64dd584fe647eab3">spi0</a>.<a class="code" href="structspi__periph.html#a8b32489ec5498094c97fd4d31209ab47">init_struct</a> = &amp;<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a7d8ebbd3680a7fc3e33eaf638f396c18">spi0_dma</a>;
<a name="l00255"></a>00255   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a7d8ebbd3680a7fc3e33eaf638f396c18">spi0_dma</a>.<a class="code" href="structspi__periph__dma.html#aa38bcf805c46baa4d49f4ace89cfed57">spi</a> = SPI3;
<a name="l00256"></a>00256   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a7d8ebbd3680a7fc3e33eaf638f396c18">spi0_dma</a>.<a class="code" href="structspi__periph__dma.html#aa2f4122476bc251c47e2d2eca91f296e">spidr</a> = (u32)&amp;SPI3_DR;
<a name="l00257"></a>00257   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a7d8ebbd3680a7fc3e33eaf638f396c18">spi0_dma</a>.<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a> = DMA2;
<a name="l00258"></a>00258   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a7d8ebbd3680a7fc3e33eaf638f396c18">spi0_dma</a>.<a class="code" href="structspi__periph__dma.html#aefcd5ba30da5eaf93f6d3e0a29ee9467">rx_chan</a> = DMA_CHANNEL1;
<a name="l00259"></a>00259   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a7d8ebbd3680a7fc3e33eaf638f396c18">spi0_dma</a>.<a class="code" href="structspi__periph__dma.html#aff566f47d98f3f04370908401ad6c47d">tx_chan</a> = DMA_CHANNEL2;
<a name="l00260"></a>00260   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a7d8ebbd3680a7fc3e33eaf638f396c18">spi0_dma</a>.<a class="code" href="structspi__periph__dma.html#a9a689b71e186b6ceee15cc0e94f621d2">nvic_irq</a> = NVIC_DMA2_CHANNEL1_IRQ;
<a name="l00261"></a>00261 
<a name="l00262"></a>00262   <a class="code" href="group__spi.html#gae920399b05f855df64dd584fe647eab3">spi0</a>.<a class="code" href="structspi__periph.html#ab96104b648a016e934752e01ec4f2b59">trans_insert_idx</a> = 0;
<a name="l00263"></a>00263   <a class="code" href="group__spi.html#gae920399b05f855df64dd584fe647eab3">spi0</a>.<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a> = 0;
<a name="l00264"></a>00264   <a class="code" href="group__spi.html#gae920399b05f855df64dd584fe647eab3">spi0</a>.<a class="code" href="structspi__periph.html#a413be255346b4fefbb01e9a55ee8a286">status</a> = <a class="code" href="group__spi.html#gga495f0019475966e28264aaf8e37c6529a043fd5f30e831835768732e5f373dada">SPIIdle</a>;
<a name="l00265"></a>00265 
<a name="l00266"></a>00266   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a92d285e5b860130426aa3ce1369df0c9" title="Enable DMA rx channel interrupt.">spi_arch_int_enable</a>( &amp;<a class="code" href="group__spi.html#gae920399b05f855df64dd584fe647eab3">spi0</a> );
<a name="l00267"></a>00267 }
<a name="l00268"></a>00268 <span class="preprocessor">#endif</span>
<a name="l00269"></a>00269 <span class="preprocessor"></span>
<a name="l00270"></a>00270 <span class="preprocessor">#if USE_SPI1</span>
<a name="l00271"></a><a class="code" href="group__spi.html#gaaba00866ddaf960c0c761e61f81e5216">00271</a> <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="group__spi.html#gaaba00866ddaf960c0c761e61f81e5216" title="Architecture dependant SPI1 initialization.">spi1_arch_init</a>(<span class="keywordtype">void</span>) {
<a name="l00272"></a>00272 
<a name="l00273"></a>00273   <span class="comment">// Enable SPI1 Periph and gpio clocks -------------------------------------------------</span>
<a name="l00274"></a>00274   rcc_peripheral_enable_clock(&amp;RCC_APB2ENR, RCC_APB2ENR_SPI1EN);
<a name="l00275"></a>00275 
<a name="l00276"></a>00276   <span class="comment">// Configure GPIOs: SCK, MISO and MOSI  --------------------------------</span>
<a name="l00277"></a>00277   gpio_set_mode(GPIO_BANK_SPI1_SCK, GPIO_MODE_OUTPUT_50_MHZ,
<a name="l00278"></a>00278             GPIO_CNF_OUTPUT_ALTFN_PUSHPULL, GPIO_SPI1_SCK |
<a name="l00279"></a>00279                                             GPIO_SPI1_MOSI);
<a name="l00280"></a>00280 
<a name="l00281"></a>00281   gpio_set_mode(GPIO_BANK_SPI1_MISO, GPIO_MODE_INPUT, GPIO_CNF_INPUT_FLOAT,
<a name="l00282"></a>00282           GPIO_SPI1_MISO);
<a name="l00283"></a>00283 
<a name="l00284"></a>00284   <span class="comment">// reset SPI</span>
<a name="l00285"></a>00285   spi_reset(<a class="code" href="LPC21xx_8h.html#ad483be344a28ac800be8f03654a9612f">SPI1</a>);
<a name="l00286"></a>00286 
<a name="l00287"></a>00287   <span class="comment">// Disable SPI peripheral</span>
<a name="l00288"></a>00288   spi_disable(<a class="code" href="LPC21xx_8h.html#ad483be344a28ac800be8f03654a9612f">SPI1</a>);
<a name="l00289"></a>00289 
<a name="l00290"></a>00290   <span class="comment">// Initialize the slave select pins</span>
<a name="l00291"></a>00291   <span class="comment">// done from mcu_init, is it really necessary to do that here?</span>
<a name="l00292"></a>00292   <span class="comment">//spi_init_slaves();</span>
<a name="l00293"></a>00293 
<a name="l00294"></a>00294   <span class="comment">// rcc_peripheral_enable_clock(&amp;RCC_AHBENR, RCC_AHBENR_OTGFSEN);</span>
<a name="l00295"></a>00295 
<a name="l00296"></a>00296   <span class="comment">// Force SPI mode over I2S.</span>
<a name="l00297"></a>00297   SPI1_I2SCFGR = 0;
<a name="l00298"></a>00298 
<a name="l00299"></a>00299   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a1fcd46a62bab151ce1f91b72cdbe3568">spi1_dma</a>.<a class="code" href="structspi__periph__dma.html#a63a1d0e3e71a13741454f9d4bec52145">config</a> = (<a class="code" href="group__spi.html#ggab7f6befabf036cdd2fcc73e688d17f92a616ab1558f18f3b3c58f22e0f16fe40e">SPIDss8bit</a> &lt;&lt; 6) | (<a class="code" href="group__spi.html#ggaaabe4f085d398b1dabe6526437d0069baedf1306791ecf55a11a2a37dbbd6b1b1">SPIDiv64</a> &lt;&lt; 3) | (<a class="code" href="group__spi.html#ggaa97b351a297dda534c3f9cee0d5b4647ab95f234ab8475459a286da0c132240e9">SPIMSBFirst</a> &lt;&lt; 2) | (<a class="code" href="group__spi.html#gga133152bd9fd803ef729bdfb9dc488baaa0819b3eda26f2666ff69ced98db281ce">SPICphaEdge2</a> &lt;&lt; 1) | (<a class="code" href="group__spi.html#gga585d188d86d5ad9a6fe2d3d11af58ca7abb9d597cb05133176eac7d6a87b5f9af">SPICpolIdleHigh</a>);
<a name="l00300"></a>00300 
<a name="l00301"></a>00301   <span class="comment">// configure master SPI.</span>
<a name="l00302"></a>00302   spi_init_master(<a class="code" href="LPC21xx_8h.html#ad483be344a28ac800be8f03654a9612f">SPI1</a>, SPI_CR1_BAUDRATE_FPCLK_DIV_64, SPI_CR1_CPOL_CLK_TO_1_WHEN_IDLE,
<a name="l00303"></a>00303                   SPI_CR1_CPHA_CLK_TRANSITION_2, SPI_CR1_DFF_8BIT, SPI_CR1_MSBFIRST);
<a name="l00304"></a>00304 
<a name="l00305"></a>00305   <span class="comment">/*</span>
<a name="l00306"></a>00306 <span class="comment">   * Set NSS management to software.</span>
<a name="l00307"></a>00307 <span class="comment">   *</span>
<a name="l00308"></a>00308 <span class="comment">   * Note:</span>
<a name="l00309"></a>00309 <span class="comment">   * Setting nss high is very important, even if we are controlling the GPIO</span>
<a name="l00310"></a>00310 <span class="comment">   * ourselves this bit needs to be at least set to 1, otherwise the spi</span>
<a name="l00311"></a>00311 <span class="comment">   * peripheral will not send any data out.</span>
<a name="l00312"></a>00312 <span class="comment">   */</span>
<a name="l00313"></a>00313   spi_enable_software_slave_management(<a class="code" href="LPC21xx_8h.html#ad483be344a28ac800be8f03654a9612f">SPI1</a>);
<a name="l00314"></a>00314   spi_set_nss_high(<a class="code" href="LPC21xx_8h.html#ad483be344a28ac800be8f03654a9612f">SPI1</a>);
<a name="l00315"></a>00315 
<a name="l00316"></a>00316   <span class="comment">// Enable SPI_1 DMA clock ---------------------------------------------------</span>
<a name="l00317"></a>00317   rcc_peripheral_enable_clock(&amp;RCC_AHBENR, RCC_AHBENR_DMA1EN);
<a name="l00318"></a>00318 
<a name="l00319"></a>00319   <span class="comment">// Enable SPI1 periph.</span>
<a name="l00320"></a>00320   spi_enable(<a class="code" href="LPC21xx_8h.html#ad483be344a28ac800be8f03654a9612f">SPI1</a>);
<a name="l00321"></a>00321 
<a name="l00322"></a>00322   <a class="code" href="group__spi.html#gaedccba8390a9d630d522a0b282c4f9b9">spi1</a>.<a class="code" href="structspi__periph.html#a8b32489ec5498094c97fd4d31209ab47">init_struct</a> = &amp;<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a1fcd46a62bab151ce1f91b72cdbe3568">spi1_dma</a>;
<a name="l00323"></a>00323   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a1fcd46a62bab151ce1f91b72cdbe3568">spi1_dma</a>.<a class="code" href="structspi__periph__dma.html#aa38bcf805c46baa4d49f4ace89cfed57">spi</a> = <a class="code" href="LPC21xx_8h.html#ad483be344a28ac800be8f03654a9612f">SPI1</a>;
<a name="l00324"></a>00324   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a1fcd46a62bab151ce1f91b72cdbe3568">spi1_dma</a>.<a class="code" href="structspi__periph__dma.html#aa2f4122476bc251c47e2d2eca91f296e">spidr</a> = (u32)&amp;SPI1_DR;
<a name="l00325"></a>00325   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a1fcd46a62bab151ce1f91b72cdbe3568">spi1_dma</a>.<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a> = DMA1;
<a name="l00326"></a>00326   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a1fcd46a62bab151ce1f91b72cdbe3568">spi1_dma</a>.<a class="code" href="structspi__periph__dma.html#aefcd5ba30da5eaf93f6d3e0a29ee9467">rx_chan</a> = DMA_CHANNEL2;
<a name="l00327"></a>00327   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a1fcd46a62bab151ce1f91b72cdbe3568">spi1_dma</a>.<a class="code" href="structspi__periph__dma.html#aff566f47d98f3f04370908401ad6c47d">tx_chan</a> = DMA_CHANNEL3;
<a name="l00328"></a>00328   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a1fcd46a62bab151ce1f91b72cdbe3568">spi1_dma</a>.<a class="code" href="structspi__periph__dma.html#a9a689b71e186b6ceee15cc0e94f621d2">nvic_irq</a> = NVIC_DMA1_CHANNEL2_IRQ;
<a name="l00329"></a>00329 
<a name="l00330"></a>00330   <a class="code" href="group__spi.html#gaedccba8390a9d630d522a0b282c4f9b9">spi1</a>.<a class="code" href="structspi__periph.html#ab96104b648a016e934752e01ec4f2b59">trans_insert_idx</a> = 0;
<a name="l00331"></a>00331   <a class="code" href="group__spi.html#gaedccba8390a9d630d522a0b282c4f9b9">spi1</a>.<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a> = 0;
<a name="l00332"></a>00332   <a class="code" href="group__spi.html#gaedccba8390a9d630d522a0b282c4f9b9">spi1</a>.<a class="code" href="structspi__periph.html#a413be255346b4fefbb01e9a55ee8a286">status</a> = <a class="code" href="group__spi.html#gga495f0019475966e28264aaf8e37c6529a043fd5f30e831835768732e5f373dada">SPIIdle</a>;
<a name="l00333"></a>00333 
<a name="l00334"></a>00334   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a92d285e5b860130426aa3ce1369df0c9" title="Enable DMA rx channel interrupt.">spi_arch_int_enable</a>( &amp;<a class="code" href="group__spi.html#gaedccba8390a9d630d522a0b282c4f9b9">spi1</a> );
<a name="l00335"></a>00335 }
<a name="l00336"></a>00336 <span class="preprocessor">#endif</span>
<a name="l00337"></a>00337 <span class="preprocessor"></span>
<a name="l00338"></a>00338 <span class="preprocessor">#if USE_SPI2</span>
<a name="l00339"></a><a class="code" href="group__spi.html#gae6c7e2bb3fb354f3b98282386b41bf70">00339</a> <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="group__spi.html#gae6c7e2bb3fb354f3b98282386b41bf70" title="Architecture dependant SPI2 initialization.">spi2_arch_init</a>(<span class="keywordtype">void</span>) {
<a name="l00340"></a>00340 
<a name="l00341"></a>00341   <span class="comment">// Enable SPI2 Periph and gpio clocks -------------------------------------------------</span>
<a name="l00342"></a>00342   rcc_peripheral_enable_clock(&amp;RCC_APB1ENR, RCC_APB1ENR_SPI2EN);
<a name="l00343"></a>00343 
<a name="l00344"></a>00344   <span class="comment">// Configure GPIOs: SCK, MISO and MOSI  --------------------------------</span>
<a name="l00345"></a>00345   gpio_set_mode(GPIO_BANK_SPI2_SCK, GPIO_MODE_OUTPUT_50_MHZ,
<a name="l00346"></a>00346             GPIO_CNF_OUTPUT_ALTFN_PUSHPULL, GPIO_SPI2_SCK |
<a name="l00347"></a>00347                                             GPIO_SPI2_MOSI);
<a name="l00348"></a>00348 
<a name="l00349"></a>00349   gpio_set_mode(GPIO_BANK_SPI2_MISO, GPIO_MODE_INPUT, GPIO_CNF_INPUT_FLOAT,
<a name="l00350"></a>00350           GPIO_SPI2_MISO);
<a name="l00351"></a>00351 
<a name="l00352"></a>00352   <span class="comment">// reset SPI</span>
<a name="l00353"></a>00353   spi_reset(SPI2);
<a name="l00354"></a>00354 
<a name="l00355"></a>00355   <span class="comment">// Disable SPI peripheral</span>
<a name="l00356"></a>00356   spi_disable(SPI2);
<a name="l00357"></a>00357 
<a name="l00358"></a>00358   <span class="comment">// Initialize the slave select pins</span>
<a name="l00359"></a>00359   <span class="comment">// done from mcu_init, is it really necessary to do that here?</span>
<a name="l00360"></a>00360   <span class="comment">//spi_init_slaves();</span>
<a name="l00361"></a>00361 
<a name="l00362"></a>00362   <span class="comment">// rcc_peripheral_enable_clock(&amp;RCC_AHBENR, RCC_AHBENR_OTGFSEN);</span>
<a name="l00363"></a>00363 
<a name="l00364"></a>00364   <span class="comment">// Force SPI mode over I2S.</span>
<a name="l00365"></a>00365   SPI2_I2SCFGR = 0;
<a name="l00366"></a>00366 
<a name="l00367"></a>00367   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a3ef76c50f4063e0bd8f6ad418ceb8d59">spi2_dma</a>.<a class="code" href="structspi__periph__dma.html#a63a1d0e3e71a13741454f9d4bec52145">config</a> = (<a class="code" href="group__spi.html#ggab7f6befabf036cdd2fcc73e688d17f92a616ab1558f18f3b3c58f22e0f16fe40e">SPIDss8bit</a> &lt;&lt; 6) | (<a class="code" href="group__spi.html#ggaaabe4f085d398b1dabe6526437d0069baedf1306791ecf55a11a2a37dbbd6b1b1">SPIDiv64</a> &lt;&lt; 3) | (<a class="code" href="group__spi.html#ggaa97b351a297dda534c3f9cee0d5b4647ab95f234ab8475459a286da0c132240e9">SPIMSBFirst</a> &lt;&lt; 2) | (<a class="code" href="group__spi.html#gga133152bd9fd803ef729bdfb9dc488baaa0819b3eda26f2666ff69ced98db281ce">SPICphaEdge2</a> &lt;&lt; 1) | (<a class="code" href="group__spi.html#gga585d188d86d5ad9a6fe2d3d11af58ca7abb9d597cb05133176eac7d6a87b5f9af">SPICpolIdleHigh</a>);
<a name="l00368"></a>00368 
<a name="l00369"></a>00369   <span class="comment">// configure master SPI.</span>
<a name="l00370"></a>00370   spi_init_master(SPI2, SPI_CR1_BAUDRATE_FPCLK_DIV_64, SPI_CR1_CPOL_CLK_TO_1_WHEN_IDLE,
<a name="l00371"></a>00371                   SPI_CR1_CPHA_CLK_TRANSITION_2, SPI_CR1_DFF_8BIT, SPI_CR1_MSBFIRST);
<a name="l00372"></a>00372 
<a name="l00373"></a>00373   <span class="comment">/*</span>
<a name="l00374"></a>00374 <span class="comment">   * Set NSS management to software.</span>
<a name="l00375"></a>00375 <span class="comment">   *</span>
<a name="l00376"></a>00376 <span class="comment">   * Note:</span>
<a name="l00377"></a>00377 <span class="comment">   * Setting nss high is very important, even if we are controlling the GPIO</span>
<a name="l00378"></a>00378 <span class="comment">   * ourselves this bit needs to be at least set to 1, otherwise the spi</span>
<a name="l00379"></a>00379 <span class="comment">   * peripheral will not send any data out.</span>
<a name="l00380"></a>00380 <span class="comment">   */</span>
<a name="l00381"></a>00381   spi_enable_software_slave_management(SPI2);
<a name="l00382"></a>00382   spi_set_nss_high(SPI2);
<a name="l00383"></a>00383 
<a name="l00384"></a>00384   <span class="comment">// Enable SPI_2 DMA clock ---------------------------------------------------</span>
<a name="l00385"></a>00385   rcc_peripheral_enable_clock(&amp;RCC_AHBENR, RCC_AHBENR_DMA1EN);
<a name="l00386"></a>00386 
<a name="l00387"></a>00387   <span class="comment">// Enable SPI2 periph.</span>
<a name="l00388"></a>00388   spi_enable(SPI2);
<a name="l00389"></a>00389 
<a name="l00390"></a>00390   <a class="code" href="group__spi.html#gabc3004247e95c09c15cfdf7d3e6402b7">spi2</a>.<a class="code" href="structspi__periph.html#a8b32489ec5498094c97fd4d31209ab47">init_struct</a> = &amp;<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a3ef76c50f4063e0bd8f6ad418ceb8d59">spi2_dma</a>;
<a name="l00391"></a>00391   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a3ef76c50f4063e0bd8f6ad418ceb8d59">spi2_dma</a>.<a class="code" href="structspi__periph__dma.html#aa38bcf805c46baa4d49f4ace89cfed57">spi</a> = SPI2;
<a name="l00392"></a>00392   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a3ef76c50f4063e0bd8f6ad418ceb8d59">spi2_dma</a>.<a class="code" href="structspi__periph__dma.html#aa2f4122476bc251c47e2d2eca91f296e">spidr</a> = (u32)&amp;SPI2_DR;
<a name="l00393"></a>00393   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a3ef76c50f4063e0bd8f6ad418ceb8d59">spi2_dma</a>.<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a> = DMA1;
<a name="l00394"></a>00394   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a3ef76c50f4063e0bd8f6ad418ceb8d59">spi2_dma</a>.<a class="code" href="structspi__periph__dma.html#aefcd5ba30da5eaf93f6d3e0a29ee9467">rx_chan</a> = DMA_CHANNEL4;
<a name="l00395"></a>00395   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a3ef76c50f4063e0bd8f6ad418ceb8d59">spi2_dma</a>.<a class="code" href="structspi__periph__dma.html#aff566f47d98f3f04370908401ad6c47d">tx_chan</a> = DMA_CHANNEL5;
<a name="l00396"></a>00396   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a3ef76c50f4063e0bd8f6ad418ceb8d59">spi2_dma</a>.<a class="code" href="structspi__periph__dma.html#a9a689b71e186b6ceee15cc0e94f621d2">nvic_irq</a> = NVIC_DMA1_CHANNEL4_IRQ;
<a name="l00397"></a>00397 
<a name="l00398"></a>00398   <a class="code" href="group__spi.html#gabc3004247e95c09c15cfdf7d3e6402b7">spi2</a>.<a class="code" href="structspi__periph.html#ab96104b648a016e934752e01ec4f2b59">trans_insert_idx</a> = 0;
<a name="l00399"></a>00399   <a class="code" href="group__spi.html#gabc3004247e95c09c15cfdf7d3e6402b7">spi2</a>.<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a> = 0;
<a name="l00400"></a>00400   <a class="code" href="group__spi.html#gabc3004247e95c09c15cfdf7d3e6402b7">spi2</a>.<a class="code" href="structspi__periph.html#a413be255346b4fefbb01e9a55ee8a286">status</a> = <a class="code" href="group__spi.html#gga495f0019475966e28264aaf8e37c6529a043fd5f30e831835768732e5f373dada">SPIIdle</a>;
<a name="l00401"></a>00401 
<a name="l00402"></a>00402   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a92d285e5b860130426aa3ce1369df0c9" title="Enable DMA rx channel interrupt.">spi_arch_int_enable</a>( &amp;<a class="code" href="group__spi.html#gabc3004247e95c09c15cfdf7d3e6402b7">spi2</a> );
<a name="l00403"></a>00403 }
<a name="l00404"></a>00404 <span class="preprocessor">#endif</span>
<a name="l00405"></a>00405 <span class="preprocessor"></span>
<a name="l00406"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#aa2be57519fcaa1b2795cdd27016ff696">00406</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#aa2be57519fcaa1b2795cdd27016ff696">spi_rw</a>(<span class="keyword">struct</span> <a class="code" href="structspi__periph.html">spi_periph</a>* <a class="code" href="ins__alt__float_8c.html#a9d3f100c4375da4d957dbe599d494905">p</a>, <span class="keyword">struct</span> <a class="code" href="structspi__transaction.html" title="SPI transaction structure.">spi_transaction</a>  * _trans)
<a name="l00407"></a>00407 {
<a name="l00408"></a>00408   <span class="keyword">struct </span><a class="code" href="structspi__periph__dma.html" title="This structure keeps track of specific ID&#39;s for each SPI bus, which allows for more code reuse...">spi_periph_dma</a> *<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>;
<a name="l00409"></a>00409   <a class="code" href="types_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> <a class="code" href="structspi__periph__dma.html#a63a1d0e3e71a13741454f9d4bec52145">config</a> = 0x00;
<a name="l00410"></a>00410 
<a name="l00411"></a>00411   <span class="comment">// Store local copy to notify of the results</span>
<a name="l00412"></a>00412   _trans-&gt;<a class="code" href="structspi__transaction.html#afcc49de6913e59398111a070be5aeda2">status</a> = <a class="code" href="group__spi.html#gga52e70c55efc6a9b04903157a0965baacaa9502bb1de8d8491ceb5443ef51c4f4a">SPITransRunning</a>;
<a name="l00413"></a>00413   p-&gt;<a class="code" href="structspi__periph.html#a413be255346b4fefbb01e9a55ee8a286">status</a> = <a class="code" href="group__spi.html#gga495f0019475966e28264aaf8e37c6529a55c7e2679f705c1f9e501a69908f7f28">SPIRunning</a>;
<a name="l00414"></a>00414 
<a name="l00415"></a>00415   <span class="keywordflow">if</span> ( _trans-&gt;<a class="code" href="structspi__transaction.html#a2716d9d8e12e4b02d9093bfbe01346ba">select</a> == <a class="code" href="group__spi.html#gga7a54d65ebae5c91cb0b5f28cd7111ae3aba395831c171e283b2479f63db99d00c">SPISelectUnselect</a> || _trans-&gt;<a class="code" href="structspi__transaction.html#a2716d9d8e12e4b02d9093bfbe01346ba">select</a> == <a class="code" href="group__spi.html#gga7a54d65ebae5c91cb0b5f28cd7111ae3a0e6e45a45e7561f69cca8cfbe140758b">SPISelect</a> ) {
<a name="l00416"></a>00416     <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#ab639bd461acc9159f2a8566bfe1ebdd0">SpiSlaveSelect</a>( _trans-&gt;<a class="code" href="structspi__transaction.html#ad172d82768bb46939cb4e6ffbd230e77">slave_idx</a> );
<a name="l00417"></a>00417   }
<a name="l00418"></a>00418 
<a name="l00419"></a>00419   dma = p-&gt;<a class="code" href="structspi__periph.html#a8b32489ec5498094c97fd4d31209ab47">init_struct</a>;
<a name="l00420"></a>00420 
<a name="l00421"></a>00421   config = (_trans-&gt;<a class="code" href="structspi__transaction.html#a815b95697425c9e24fb81e83f4a13385">dss</a> &lt;&lt; 6) | (_trans-&gt;<a class="code" href="structspi__transaction.html#a8d8c70f4ac840678b944e410e93f779e">cdiv</a> &lt;&lt; 3) | (_trans-&gt;<a class="code" href="structspi__transaction.html#af804a20f8372631a24aad61be1383307">bitorder</a> &lt;&lt; 2) | (_trans-&gt;<a class="code" href="structspi__transaction.html#a1ffecb70c8f221ab1296d06e61448485">cpha</a> &lt;&lt; 1) | (_trans-&gt;<a class="code" href="structspi__transaction.html#a1c63fdf45b423a121cf0666a8aaa2539">cpol</a>);
<a name="l00422"></a>00422   <span class="keywordflow">if</span> ( config != dma-&gt;<a class="code" href="structspi__periph__dma.html#a63a1d0e3e71a13741454f9d4bec52145">config</a> ) {
<a name="l00423"></a>00423     dma-&gt;<a class="code" href="structspi__periph__dma.html#a63a1d0e3e71a13741454f9d4bec52145">config</a> = <a class="code" href="structspi__periph__dma.html#a63a1d0e3e71a13741454f9d4bec52145">config</a>;
<a name="l00424"></a>00424 
<a name="l00425"></a>00425     <span class="comment">// A different config is required in this transaction...</span>
<a name="l00426"></a>00426     <span class="keywordflow">if</span> ( _trans-&gt;<a class="code" href="structspi__transaction.html#a815b95697425c9e24fb81e83f4a13385">dss</a> == <a class="code" href="group__spi.html#ggab7f6befabf036cdd2fcc73e688d17f92a616ab1558f18f3b3c58f22e0f16fe40e">SPIDss8bit</a> ) {
<a name="l00427"></a>00427       dma-&gt;<a class="code" href="structspi__periph__dma.html#a94a24ec6125f696b505ecfb97352732b">dss</a> = SPI_CR1_DFF_8BIT;
<a name="l00428"></a>00428     } <span class="keywordflow">else</span> {
<a name="l00429"></a>00429       dma-&gt;<a class="code" href="structspi__periph__dma.html#a94a24ec6125f696b505ecfb97352732b">dss</a> = SPI_CR1_DFF_16BIT;
<a name="l00430"></a>00430     }
<a name="l00431"></a>00431     <span class="keywordflow">if</span> ( _trans-&gt;<a class="code" href="structspi__transaction.html#af804a20f8372631a24aad61be1383307">bitorder</a> == <a class="code" href="group__spi.html#ggaa97b351a297dda534c3f9cee0d5b4647ab95f234ab8475459a286da0c132240e9">SPIMSBFirst</a> ) {
<a name="l00432"></a>00432       dma-&gt;<a class="code" href="structspi__periph__dma.html#a6956aff142bd54afdb5a60540c939b59">bo</a> = SPI_CR1_MSBFIRST;
<a name="l00433"></a>00433     } <span class="keywordflow">else</span> {
<a name="l00434"></a>00434       dma-&gt;<a class="code" href="structspi__periph__dma.html#a6956aff142bd54afdb5a60540c939b59">bo</a> = SPI_CR1_LSBFIRST;
<a name="l00435"></a>00435     }
<a name="l00436"></a>00436     <span class="keywordflow">if</span> ( _trans-&gt;<a class="code" href="structspi__transaction.html#a1ffecb70c8f221ab1296d06e61448485">cpha</a> == <a class="code" href="group__spi.html#gga133152bd9fd803ef729bdfb9dc488baaaef9737139e9d1ed3ef30d2200acc629e">SPICphaEdge1</a> ) {
<a name="l00437"></a>00437       dma-&gt;<a class="code" href="structspi__periph__dma.html#a5764478239bc4fa5aa4a37d690dfe392">cpha</a> = SPI_CR1_CPHA_CLK_TRANSITION_1;
<a name="l00438"></a>00438     } <span class="keywordflow">else</span> {
<a name="l00439"></a>00439       dma-&gt;<a class="code" href="structspi__periph__dma.html#a5764478239bc4fa5aa4a37d690dfe392">cpha</a> = SPI_CR1_CPHA_CLK_TRANSITION_2;
<a name="l00440"></a>00440     }
<a name="l00441"></a>00441     <span class="keywordflow">if</span> ( _trans-&gt;<a class="code" href="structspi__transaction.html#a1c63fdf45b423a121cf0666a8aaa2539">cpol</a> == <a class="code" href="group__spi.html#gga585d188d86d5ad9a6fe2d3d11af58ca7a88d8aa68a47badab24e8237a333cc029">SPICpolIdleLow</a> ) {
<a name="l00442"></a>00442       dma-&gt;<a class="code" href="structspi__periph__dma.html#a45a21a79c2eef245ad0fd0889fd5e0a4">cpol</a> = SPI_CR1_CPOL_CLK_TO_0_WHEN_IDLE;
<a name="l00443"></a>00443     } <span class="keywordflow">else</span> {
<a name="l00444"></a>00444       dma-&gt;<a class="code" href="structspi__periph__dma.html#a45a21a79c2eef245ad0fd0889fd5e0a4">cpol</a> = SPI_CR1_CPOL_CLK_TO_1_WHEN_IDLE;
<a name="l00445"></a>00445     }
<a name="l00446"></a>00446 
<a name="l00447"></a>00447     <span class="keywordflow">switch</span>( _trans-&gt;<a class="code" href="structspi__transaction.html#a8d8c70f4ac840678b944e410e93f779e">cdiv</a> ) {
<a name="l00448"></a>00448       <span class="keywordflow">case</span> <a class="code" href="group__spi.html#ggaaabe4f085d398b1dabe6526437d0069ba32d98a42e45177c17732d3388c7db470">SPIDiv2</a>:
<a name="l00449"></a>00449         dma-&gt;<a class="code" href="structspi__periph__dma.html#a82c273595bab7bef077bd999a3a24f1f">cdiv</a> = SPI_CR1_BAUDRATE_FPCLK_DIV_2;
<a name="l00450"></a>00450         <span class="keywordflow">break</span>;
<a name="l00451"></a>00451       <span class="keywordflow">case</span> <a class="code" href="group__spi.html#ggaaabe4f085d398b1dabe6526437d0069ba02d4312b29bafe6c8cebac74e7160f6c">SPIDiv4</a>:
<a name="l00452"></a>00452         dma-&gt;<a class="code" href="structspi__periph__dma.html#a82c273595bab7bef077bd999a3a24f1f">cdiv</a> = SPI_CR1_BAUDRATE_FPCLK_DIV_4;
<a name="l00453"></a>00453         <span class="keywordflow">break</span>;
<a name="l00454"></a>00454       <span class="keywordflow">case</span> <a class="code" href="group__spi.html#ggaaabe4f085d398b1dabe6526437d0069ba069c09961b2c5687f6b657659d891074">SPIDiv8</a>:
<a name="l00455"></a>00455         dma-&gt;<a class="code" href="structspi__periph__dma.html#a82c273595bab7bef077bd999a3a24f1f">cdiv</a> = SPI_CR1_BAUDRATE_FPCLK_DIV_8;
<a name="l00456"></a>00456         <span class="keywordflow">break</span>;
<a name="l00457"></a>00457       <span class="keywordflow">case</span> <a class="code" href="group__spi.html#ggaaabe4f085d398b1dabe6526437d0069baf3bcf0017ccafa26ed467d7a4474b167">SPIDiv16</a>:
<a name="l00458"></a>00458         dma-&gt;<a class="code" href="structspi__periph__dma.html#a82c273595bab7bef077bd999a3a24f1f">cdiv</a> = SPI_CR1_BAUDRATE_FPCLK_DIV_16;
<a name="l00459"></a>00459         <span class="keywordflow">break</span>;
<a name="l00460"></a>00460       <span class="keywordflow">case</span> <a class="code" href="group__spi.html#ggaaabe4f085d398b1dabe6526437d0069baa2b44a4b5e42910ff3ac1243d150ef8f">SPIDiv32</a>:
<a name="l00461"></a>00461         dma-&gt;<a class="code" href="structspi__periph__dma.html#a82c273595bab7bef077bd999a3a24f1f">cdiv</a> = SPI_CR1_BAUDRATE_FPCLK_DIV_32;
<a name="l00462"></a>00462         <span class="keywordflow">break</span>;
<a name="l00463"></a>00463       <span class="keywordflow">case</span> <a class="code" href="group__spi.html#ggaaabe4f085d398b1dabe6526437d0069baedf1306791ecf55a11a2a37dbbd6b1b1">SPIDiv64</a>:
<a name="l00464"></a>00464         dma-&gt;<a class="code" href="structspi__periph__dma.html#a82c273595bab7bef077bd999a3a24f1f">cdiv</a> = SPI_CR1_BAUDRATE_FPCLK_DIV_64;
<a name="l00465"></a>00465         <span class="keywordflow">break</span>;
<a name="l00466"></a>00466       <span class="keywordflow">case</span> <a class="code" href="group__spi.html#ggaaabe4f085d398b1dabe6526437d0069ba82c78797afbfbba58ef1f977ef52691f">SPIDiv128</a>:
<a name="l00467"></a>00467         dma-&gt;<a class="code" href="structspi__periph__dma.html#a82c273595bab7bef077bd999a3a24f1f">cdiv</a> = SPI_CR1_BAUDRATE_FPCLK_DIV_128;
<a name="l00468"></a>00468         <span class="keywordflow">break</span>;
<a name="l00469"></a>00469       <span class="keywordflow">case</span> <a class="code" href="group__spi.html#ggaaabe4f085d398b1dabe6526437d0069ba5d633b4ee4d696627a0c4b437a20e2a9">SPIDiv256</a>:
<a name="l00470"></a>00470         dma-&gt;<a class="code" href="structspi__periph__dma.html#a82c273595bab7bef077bd999a3a24f1f">cdiv</a> = SPI_CR1_BAUDRATE_FPCLK_DIV_256;
<a name="l00471"></a>00471         <span class="keywordflow">break</span>;
<a name="l00472"></a>00472       <span class="keywordflow">default</span>:
<a name="l00473"></a>00473         <span class="keywordflow">break</span>;
<a name="l00474"></a>00474     }
<a name="l00475"></a>00475 
<a name="l00476"></a>00476     spi_disable( dma-&gt;<a class="code" href="structspi__periph__dma.html#aa38bcf805c46baa4d49f4ace89cfed57">spi</a> );
<a name="l00477"></a>00477     spi_init_master( dma-&gt;<a class="code" href="structspi__periph__dma.html#aa38bcf805c46baa4d49f4ace89cfed57">spi</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#a82c273595bab7bef077bd999a3a24f1f">cdiv</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#a45a21a79c2eef245ad0fd0889fd5e0a4">cpol</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#a5764478239bc4fa5aa4a37d690dfe392">cpha</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#a94a24ec6125f696b505ecfb97352732b">dss</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#a6956aff142bd54afdb5a60540c939b59">bo</a> );
<a name="l00478"></a>00478     spi_enable_software_slave_management( dma-&gt;<a class="code" href="structspi__periph__dma.html#aa38bcf805c46baa4d49f4ace89cfed57">spi</a> );
<a name="l00479"></a>00479     spi_set_nss_high( dma-&gt;<a class="code" href="structspi__periph__dma.html#aa38bcf805c46baa4d49f4ace89cfed57">spi</a> );
<a name="l00480"></a>00480     spi_enable( dma-&gt;<a class="code" href="structspi__periph__dma.html#aa38bcf805c46baa4d49f4ace89cfed57">spi</a> );
<a name="l00481"></a>00481     <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a92d285e5b860130426aa3ce1369df0c9" title="Enable DMA rx channel interrupt.">spi_arch_int_enable</a>( p );
<a name="l00482"></a>00482   }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484   <span class="keywordflow">if</span> ( _trans-&gt;<a class="code" href="structspi__transaction.html#a5d8b23bac2976e4245ac19747a122e71">input_length</a> &gt; 0 ) {
<a name="l00485"></a>00485     <span class="comment">// Rx_DMA_Channel configuration ------------------------------------</span>
<a name="l00486"></a>00486     dma_channel_reset( dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aefcd5ba30da5eaf93f6d3e0a29ee9467">rx_chan</a> );
<a name="l00487"></a>00487     dma_set_peripheral_address(dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aefcd5ba30da5eaf93f6d3e0a29ee9467">rx_chan</a>, (u32)dma-&gt;<a class="code" href="structspi__periph__dma.html#aa2f4122476bc251c47e2d2eca91f296e">spidr</a>);
<a name="l00488"></a>00488     dma_set_memory_address(dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aefcd5ba30da5eaf93f6d3e0a29ee9467">rx_chan</a>, (<a class="code" href="types_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a>)_trans-&gt;<a class="code" href="structspi__transaction.html#ab7151a300fa12304ed1f32fbe135c143">input_buf</a>);
<a name="l00489"></a>00489     dma_set_number_of_data(dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aefcd5ba30da5eaf93f6d3e0a29ee9467">rx_chan</a>, _trans-&gt;<a class="code" href="structspi__transaction.html#a5d8b23bac2976e4245ac19747a122e71">input_length</a>);
<a name="l00490"></a>00490     dma_set_read_from_peripheral(dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aefcd5ba30da5eaf93f6d3e0a29ee9467">rx_chan</a>);
<a name="l00491"></a>00491     <span class="comment">//dma_disable_peripheral_increment_mode(dma-&gt;dma, dma-&gt;rx_chan);</span>
<a name="l00492"></a>00492     dma_enable_memory_increment_mode(dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aefcd5ba30da5eaf93f6d3e0a29ee9467">rx_chan</a>);
<a name="l00493"></a>00493     dma_set_peripheral_size(dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aefcd5ba30da5eaf93f6d3e0a29ee9467">rx_chan</a>, DMA_CCR_PSIZE_8BIT);
<a name="l00494"></a>00494     dma_set_memory_size(dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aefcd5ba30da5eaf93f6d3e0a29ee9467">rx_chan</a>, DMA_CCR_MSIZE_8BIT);
<a name="l00495"></a>00495     <span class="comment">//dma_set_mode(dma-&gt;dma, dma-&gt;rx_chan, DMA_???_NORMAL);</span>
<a name="l00496"></a>00496     dma_set_priority(dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aefcd5ba30da5eaf93f6d3e0a29ee9467">rx_chan</a>, DMA_CCR_PL_VERY_HIGH);
<a name="l00497"></a>00497   }
<a name="l00498"></a>00498 
<a name="l00499"></a>00499   <span class="comment">// SPI Tx_DMA_Channel configuration ------------------------------------</span>
<a name="l00500"></a>00500   dma_channel_reset(dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aff566f47d98f3f04370908401ad6c47d">tx_chan</a>);
<a name="l00501"></a>00501   dma_set_peripheral_address(dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aff566f47d98f3f04370908401ad6c47d">tx_chan</a>, (u32)dma-&gt;<a class="code" href="structspi__periph__dma.html#aa2f4122476bc251c47e2d2eca91f296e">spidr</a>);
<a name="l00502"></a>00502   dma_set_memory_address(dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aff566f47d98f3f04370908401ad6c47d">tx_chan</a>, (<a class="code" href="types_8h.html#a06896e8c53f721507066c079052171f8">uint32_t</a>)_trans-&gt;<a class="code" href="structspi__transaction.html#a81b75a5eca2a775f4dcf89e8f1c519eb">output_buf</a>);
<a name="l00503"></a>00503   dma_set_number_of_data(dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aff566f47d98f3f04370908401ad6c47d">tx_chan</a>, _trans-&gt;<a class="code" href="structspi__transaction.html#a48d6946f5d63c9c313bdaa442b894406">output_length</a>);
<a name="l00504"></a>00504   dma_set_read_from_memory(dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aff566f47d98f3f04370908401ad6c47d">tx_chan</a>);
<a name="l00505"></a>00505   <span class="comment">//dma_disable_peripheral_increment_mode(dma-&gt;dma, dma-&gt;tx_chan);</span>
<a name="l00506"></a>00506   dma_enable_memory_increment_mode(dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aff566f47d98f3f04370908401ad6c47d">tx_chan</a>);
<a name="l00507"></a>00507   dma_set_peripheral_size(dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aff566f47d98f3f04370908401ad6c47d">tx_chan</a>, DMA_CCR_PSIZE_8BIT);
<a name="l00508"></a>00508   dma_set_memory_size(dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aff566f47d98f3f04370908401ad6c47d">tx_chan</a>, DMA_CCR_MSIZE_8BIT);
<a name="l00509"></a>00509   <span class="comment">//dma_set_mode(dma-&gt;dma, dma-&gt;tx_chan, DMA_???_NORMAL);</span>
<a name="l00510"></a>00510   dma_set_priority(dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aff566f47d98f3f04370908401ad6c47d">tx_chan</a>, DMA_CCR_PL_MEDIUM);
<a name="l00511"></a>00511 
<a name="l00512"></a>00512   <span class="keywordflow">if</span> ( _trans-&gt;<a class="code" href="structspi__transaction.html#a5d8b23bac2976e4245ac19747a122e71">input_length</a> &gt; 0 ) {
<a name="l00513"></a>00513     <span class="comment">// Enable SPI Rx request</span>
<a name="l00514"></a>00514     spi_enable_rx_dma(dma-&gt;<a class="code" href="structspi__periph__dma.html#aa38bcf805c46baa4d49f4ace89cfed57">spi</a>);
<a name="l00515"></a>00515     <span class="comment">// Enable dma-&gt;dma rx channel</span>
<a name="l00516"></a>00516     dma_enable_channel(dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aefcd5ba30da5eaf93f6d3e0a29ee9467">rx_chan</a>);
<a name="l00517"></a>00517   }
<a name="l00518"></a>00518 
<a name="l00519"></a>00519   <span class="comment">// Enable SPI Tx request</span>
<a name="l00520"></a>00520   spi_enable_tx_dma(dma-&gt;<a class="code" href="structspi__periph__dma.html#aa38bcf805c46baa4d49f4ace89cfed57">spi</a>);
<a name="l00521"></a>00521   <span class="comment">// Enable dma-&gt;dma tx Channel</span>
<a name="l00522"></a>00522   dma_enable_channel(dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aff566f47d98f3f04370908401ad6c47d">tx_chan</a>);
<a name="l00523"></a>00523 
<a name="l00524"></a>00524   <span class="keywordflow">if</span> ( _trans-&gt;<a class="code" href="structspi__transaction.html#a5d8b23bac2976e4245ac19747a122e71">input_length</a> &gt; 0 ) {
<a name="l00525"></a>00525     <span class="comment">// Enable dma-&gt;dma rx Channel Transfer Complete interrupt</span>
<a name="l00526"></a>00526     dma_enable_transfer_complete_interrupt(dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aefcd5ba30da5eaf93f6d3e0a29ee9467">rx_chan</a>);
<a name="l00527"></a>00527   }
<a name="l00528"></a>00528   dma_enable_transfer_complete_interrupt(dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aff566f47d98f3f04370908401ad6c47d">tx_chan</a>);
<a name="l00529"></a>00529 }
<a name="l00530"></a>00530 
<a name="l00531"></a><a class="code" href="group__spi.html#gaf1bcfc102840a0e6287b4db20bd78337">00531</a> bool_t <a class="code" href="group__spi.html#gaf1bcfc102840a0e6287b4db20bd78337" title="Submit a spi transaction.">spi_submit</a>(<span class="keyword">struct</span> <a class="code" href="structspi__periph.html">spi_periph</a>* <a class="code" href="ins__alt__float_8c.html#a9d3f100c4375da4d957dbe599d494905">p</a>, <span class="keyword">struct</span> <a class="code" href="structspi__transaction.html" title="SPI transaction structure.">spi_transaction</a>* t)
<a name="l00532"></a>00532 {
<a name="l00533"></a>00533   <a class="code" href="types_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> idx;
<a name="l00534"></a>00534   idx = p-&gt;<a class="code" href="structspi__periph.html#ab96104b648a016e934752e01ec4f2b59">trans_insert_idx</a> + 1;
<a name="l00535"></a>00535   <span class="keywordflow">if</span> (idx &gt;= SPI_TRANSACTION_QUEUE_LEN) idx = 0;
<a name="l00536"></a>00536   <span class="keywordflow">if</span> (idx == p-&gt;<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a>) {
<a name="l00537"></a>00537     t-&gt;<a class="code" href="structspi__transaction.html#afcc49de6913e59398111a070be5aeda2">status</a> = <a class="code" href="group__spi.html#gga52e70c55efc6a9b04903157a0965baaca3f30804ee098adcaa3b21455346c3707">SPITransFailed</a>;
<a name="l00538"></a>00538     <span class="keywordflow">return</span> <a class="code" href="imu__chimu_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>; <span class="comment">/* queue full */</span>
<a name="l00539"></a>00539   }
<a name="l00540"></a>00540   t-&gt;<a class="code" href="structspi__transaction.html#afcc49de6913e59398111a070be5aeda2">status</a> = <a class="code" href="group__spi.html#gga52e70c55efc6a9b04903157a0965baacadf5763363daaa43ebba32c0f56b85db9">SPITransPending</a>;
<a name="l00541"></a>00541 
<a name="l00542"></a>00542   <span class="comment">//Disable interrupts to avoid race conflict with end of DMA transfer interrupt</span>
<a name="l00543"></a>00543   <span class="comment">//FIXME</span>
<a name="l00544"></a>00544   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a42f17f52b327c1192801fc39493f43c5" title="Disable DMA rx channel interrupt.">spi_arch_int_disable</a>( p );
<a name="l00545"></a>00545 
<a name="l00546"></a>00546   <span class="comment">// GT: no copy?  There&#39;s a queue implying a copy here...</span>
<a name="l00547"></a>00547   p-&gt;<a class="code" href="structspi__periph.html#a5f319ec82695509b414649937a379da6">trans</a>[p-&gt;<a class="code" href="structspi__periph.html#ab96104b648a016e934752e01ec4f2b59">trans_insert_idx</a>] = t;
<a name="l00548"></a>00548   p-&gt;<a class="code" href="structspi__periph.html#ab96104b648a016e934752e01ec4f2b59">trans_insert_idx</a> = idx;
<a name="l00549"></a>00549 
<a name="l00550"></a>00550   <span class="comment">/* if peripheral is idle, start the transaction */</span>
<a name="l00551"></a>00551   <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structspi__periph.html#a413be255346b4fefbb01e9a55ee8a286">status</a> == <a class="code" href="group__spi.html#gga495f0019475966e28264aaf8e37c6529a043fd5f30e831835768732e5f373dada">SPIIdle</a> &amp;&amp; !p-&gt;<a class="code" href="structspi__periph.html#acd3194574f680b35ece651e784c4327a">suspend</a>) {
<a name="l00552"></a>00552     <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#aa2be57519fcaa1b2795cdd27016ff696">spi_rw</a>(p, p-&gt;<a class="code" href="structspi__periph.html#a5f319ec82695509b414649937a379da6">trans</a>[p-&gt;<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a>]);
<a name="l00553"></a>00553   }
<a name="l00554"></a>00554   <span class="comment">//FIXME</span>
<a name="l00555"></a>00555   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a92d285e5b860130426aa3ce1369df0c9" title="Enable DMA rx channel interrupt.">spi_arch_int_enable</a>( p );
<a name="l00556"></a>00556   <span class="keywordflow">return</span> <a class="code" href="imu__chimu_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00557"></a>00557 }
<a name="l00558"></a>00558 
<a name="l00559"></a><a class="code" href="group__spi.html#gafc9125c5764a6749703ae4f1303a16f3">00559</a> <span class="keywordtype">void</span> <a class="code" href="group__spi.html#gafc9125c5764a6749703ae4f1303a16f3" title="Initialize all used slaves and uselect them.">spi_init_slaves</a>(<span class="keywordtype">void</span>) {
<a name="l00560"></a>00560 
<a name="l00561"></a>00561 <span class="preprocessor">#if USE_SPI_SLAVE0</span>
<a name="l00562"></a>00562 <span class="preprocessor"></span>  rcc_peripheral_enable_clock(&amp;RCC_APB2ENR, <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a36b52cd82ac80095040ec2ceefef4f70">SPI_SELECT_SLAVE0_PERIPH</a> | RCC_APB2ENR_AFIOEN);
<a name="l00563"></a>00563   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#af3a0a783f898c0211f2c0e5498c746a0">SpiSlaveUnselect</a>(0);
<a name="l00564"></a>00564   gpio_set(<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a62cb06db3908015c7305ca6833f90159">SPI_SELECT_SLAVE0_PORT</a>, <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a697b8e633c428bd167844542c8c1453f">SPI_SELECT_SLAVE0_PIN</a>);
<a name="l00565"></a>00565   gpio_set_mode(<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a62cb06db3908015c7305ca6833f90159">SPI_SELECT_SLAVE0_PORT</a>, GPIO_MODE_OUTPUT_50_MHZ,
<a name="l00566"></a>00566                 GPIO_CNF_OUTPUT_PUSHPULL, <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a697b8e633c428bd167844542c8c1453f">SPI_SELECT_SLAVE0_PIN</a>);
<a name="l00567"></a>00567 <span class="preprocessor">#endif</span>
<a name="l00568"></a>00568 <span class="preprocessor"></span>
<a name="l00569"></a>00569 <span class="preprocessor">#if USE_SPI_SLAVE1</span>
<a name="l00570"></a>00570 <span class="preprocessor"></span>  rcc_peripheral_enable_clock(&amp;RCC_APB2ENR, <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a59bc6942e52ff561a9cfffffb30e00a2">SPI_SELECT_SLAVE1_PERIPH</a> | RCC_APB2ENR_AFIOEN);
<a name="l00571"></a>00571   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#af3a0a783f898c0211f2c0e5498c746a0">SpiSlaveUnselect</a>(1);
<a name="l00572"></a>00572   gpio_set(<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#abed465f8e9387dc4c034b1d71989043c">SPI_SELECT_SLAVE1_PORT</a>, <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a6391f9c6d48eca04803022ab073df01a">SPI_SELECT_SLAVE1_PIN</a>);
<a name="l00573"></a>00573   gpio_set_mode(<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#abed465f8e9387dc4c034b1d71989043c">SPI_SELECT_SLAVE1_PORT</a>, GPIO_MODE_OUTPUT_50_MHZ,
<a name="l00574"></a>00574                 GPIO_CNF_OUTPUT_PUSHPULL, <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a6391f9c6d48eca04803022ab073df01a">SPI_SELECT_SLAVE1_PIN</a>);
<a name="l00575"></a>00575 <span class="preprocessor">#endif</span>
<a name="l00576"></a>00576 <span class="preprocessor"></span>
<a name="l00577"></a>00577 <span class="preprocessor">#if USE_SPI_SLAVE2</span>
<a name="l00578"></a>00578 <span class="preprocessor"></span>  rcc_peripheral_enable_clock(&amp;RCC_APB2ENR, <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#adc10ae70ef3323f58bbeb2e26b356ba3">SPI_SELECT_SLAVE2_PERIPH</a> | RCC_APB2ENR_AFIOEN);
<a name="l00579"></a>00579   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#af3a0a783f898c0211f2c0e5498c746a0">SpiSlaveUnselect</a>(2);
<a name="l00580"></a>00580   gpio_set(<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#ad1fce2206d522b24623e9b742b1f2988">SPI_SELECT_SLAVE2_PORT</a>, <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#ae006e4c20f82ac5d2104debcd8615f06">SPI_SELECT_SLAVE2_PIN</a>);
<a name="l00581"></a>00581   gpio_set_mode(<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#ad1fce2206d522b24623e9b742b1f2988">SPI_SELECT_SLAVE2_PORT</a>, GPIO_MODE_OUTPUT_50_MHZ,
<a name="l00582"></a>00582                 GPIO_CNF_OUTPUT_PUSHPULL, <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#ae006e4c20f82ac5d2104debcd8615f06">SPI_SELECT_SLAVE2_PIN</a>);
<a name="l00583"></a>00583 <span class="preprocessor">#endif</span>
<a name="l00584"></a>00584 <span class="preprocessor"></span>
<a name="l00585"></a>00585 <span class="preprocessor">#if USE_SPI_SLAVE3</span>
<a name="l00586"></a>00586 <span class="preprocessor"></span>  rcc_peripheral_enable_clock(&amp;RCC_APB2ENR, <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a85be689297fe8683500c740f75d5bf90">SPI_SELECT_SLAVE3_PERIPH</a> | RCC_APB2ENR_AFIOEN);
<a name="l00587"></a>00587   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#af3a0a783f898c0211f2c0e5498c746a0">SpiSlaveUnselect</a>(3);
<a name="l00588"></a>00588   gpio_set(<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#aaf1f83e1cd34b94de35fbbaaa7f6cb46">SPI_SELECT_SLAVE3_PORT</a>, <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a43f488034394a3e0c0749b96fdbdd08f">SPI_SELECT_SLAVE3_PIN</a>);
<a name="l00589"></a>00589   gpio_set_mode(<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#aaf1f83e1cd34b94de35fbbaaa7f6cb46">SPI_SELECT_SLAVE3_PORT</a>, GPIO_MODE_OUTPUT_50_MHZ,
<a name="l00590"></a>00590                 GPIO_CNF_OUTPUT_PUSHPULL, <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a43f488034394a3e0c0749b96fdbdd08f">SPI_SELECT_SLAVE3_PIN</a>);
<a name="l00591"></a>00591 <span class="preprocessor">#endif</span>
<a name="l00592"></a>00592 <span class="preprocessor"></span>
<a name="l00593"></a>00593 <span class="preprocessor">#if USE_SPI_SLAVE4</span>
<a name="l00594"></a>00594 <span class="preprocessor"></span>  rcc_peripheral_enable_clock(&amp;RCC_APB2ENR, <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#ad032b13900d3d088a3f1e8cc1a7cc852">SPI_SELECT_SLAVE4_PERIPH</a> | RCC_APB2ENR_AFIOEN);
<a name="l00595"></a>00595   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#af3a0a783f898c0211f2c0e5498c746a0">SpiSlaveUnselect</a>(4);
<a name="l00596"></a>00596   gpio_set(<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a68d301edae4fbbd1f4a7e9de1a9252b1">SPI_SELECT_SLAVE4_PORT</a>, <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#aaaf3b422873946314dfec6703a3a5580">SPI_SELECT_SLAVE4_PIN</a>);
<a name="l00597"></a>00597   gpio_set_mode(<a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a68d301edae4fbbd1f4a7e9de1a9252b1">SPI_SELECT_SLAVE4_PORT</a>, GPIO_MODE_OUTPUT_50_MHZ,
<a name="l00598"></a>00598                 GPIO_CNF_OUTPUT_PUSHPULL, <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#aaaf3b422873946314dfec6703a3a5580">SPI_SELECT_SLAVE4_PIN</a>);
<a name="l00599"></a>00599 <span class="preprocessor">#endif</span>
<a name="l00600"></a>00600 <span class="preprocessor"></span>
<a name="l00601"></a>00601 }
<a name="l00602"></a>00602 
<a name="l00603"></a><a class="code" href="group__spi.html#gad43916477f5d87b42eaa7d2099771568">00603</a> <span class="keywordtype">void</span> <a class="code" href="group__spi.html#gad43916477f5d87b42eaa7d2099771568" title="Select a slave.">spi_slave_select</a>(<a class="code" href="types_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> slave) {
<a name="l00604"></a>00604   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#ab639bd461acc9159f2a8566bfe1ebdd0">SpiSlaveSelect</a>(slave);
<a name="l00605"></a>00605 }
<a name="l00606"></a>00606 
<a name="l00607"></a><a class="code" href="group__spi.html#ga99507da72932c02e5d8daf9a7170ed69">00607</a> <span class="keywordtype">void</span> <a class="code" href="group__spi.html#ga99507da72932c02e5d8daf9a7170ed69" title="Unselect a slave.">spi_slave_unselect</a>(<a class="code" href="types_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> slave) {
<a name="l00608"></a>00608   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#af3a0a783f898c0211f2c0e5498c746a0">SpiSlaveUnselect</a>(slave);
<a name="l00609"></a>00609 }
<a name="l00610"></a>00610 
<a name="l00611"></a><a class="code" href="group__spi.html#ga2db1b869a8aea431e3d3e63106290db9">00611</a> bool_t <a class="code" href="group__spi.html#ga2db1b869a8aea431e3d3e63106290db9" title="Lock the SPI fifo.">spi_lock</a>(<span class="keyword">struct</span> <a class="code" href="structspi__periph.html">spi_periph</a>* <a class="code" href="ins__alt__float_8c.html#a9d3f100c4375da4d957dbe599d494905">p</a>, <a class="code" href="types_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> slave) {
<a name="l00612"></a>00612   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a42f17f52b327c1192801fc39493f43c5" title="Disable DMA rx channel interrupt.">spi_arch_int_disable</a>( p );
<a name="l00613"></a>00613   <span class="keywordflow">if</span> (slave &lt; 254 &amp;&amp; p-&gt;suspend == 0) {
<a name="l00614"></a>00614     p-&gt;<a class="code" href="structspi__periph.html#acd3194574f680b35ece651e784c4327a">suspend</a> = slave + 1; <span class="comment">// 0 is reserved for unlock state</span>
<a name="l00615"></a>00615     <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a92d285e5b860130426aa3ce1369df0c9" title="Enable DMA rx channel interrupt.">spi_arch_int_enable</a>( p );
<a name="l00616"></a>00616     <span class="keywordflow">return</span> <a class="code" href="imu__chimu_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00617"></a>00617   }
<a name="l00618"></a>00618   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a92d285e5b860130426aa3ce1369df0c9" title="Enable DMA rx channel interrupt.">spi_arch_int_enable</a>( p );
<a name="l00619"></a>00619   <span class="keywordflow">return</span> <a class="code" href="imu__chimu_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00620"></a>00620 }
<a name="l00621"></a>00621 
<a name="l00622"></a><a class="code" href="group__spi.html#ga5e9947e5b87e3a86a773b4a174ec6f08">00622</a> bool_t <a class="code" href="group__spi.html#ga5e9947e5b87e3a86a773b4a174ec6f08" title="Resume the SPI fifo.">spi_resume</a>(<span class="keyword">struct</span> <a class="code" href="structspi__periph.html">spi_periph</a>* <a class="code" href="ins__alt__float_8c.html#a9d3f100c4375da4d957dbe599d494905">p</a>, <a class="code" href="types_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a> slave) {
<a name="l00623"></a>00623   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a42f17f52b327c1192801fc39493f43c5" title="Disable DMA rx channel interrupt.">spi_arch_int_disable</a>( p );
<a name="l00624"></a>00624   <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structspi__periph.html#acd3194574f680b35ece651e784c4327a">suspend</a> == slave + 1) {
<a name="l00625"></a>00625     <span class="comment">// restart fifo</span>
<a name="l00626"></a>00626     p-&gt;<a class="code" href="structspi__periph.html#acd3194574f680b35ece651e784c4327a">suspend</a> = 0;
<a name="l00627"></a>00627     <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a> != p-&gt;<a class="code" href="structspi__periph.html#ab96104b648a016e934752e01ec4f2b59">trans_insert_idx</a> &amp;&amp; p-&gt;<a class="code" href="structspi__periph.html#a413be255346b4fefbb01e9a55ee8a286">status</a> == <a class="code" href="group__spi.html#gga495f0019475966e28264aaf8e37c6529a043fd5f30e831835768732e5f373dada">SPIIdle</a>) {
<a name="l00628"></a>00628       <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#aa2be57519fcaa1b2795cdd27016ff696">spi_rw</a>( p, p-&gt;<a class="code" href="structspi__periph.html#a5f319ec82695509b414649937a379da6">trans</a>[p-&gt;<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a>] );
<a name="l00629"></a>00629     }
<a name="l00630"></a>00630     <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a92d285e5b860130426aa3ce1369df0c9" title="Enable DMA rx channel interrupt.">spi_arch_int_enable</a>( p );
<a name="l00631"></a>00631     <span class="keywordflow">return</span> <a class="code" href="imu__chimu_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00632"></a>00632   }
<a name="l00633"></a>00633   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a92d285e5b860130426aa3ce1369df0c9" title="Enable DMA rx channel interrupt.">spi_arch_int_enable</a>( p );
<a name="l00634"></a>00634   <span class="keywordflow">return</span> <a class="code" href="imu__chimu_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00635"></a>00635 }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637 
<a name="l00638"></a>00638 <span class="preprocessor">#ifdef USE_SPI1</span>
<a name="l00639"></a>00639 <span class="preprocessor"></span>
<a name="l00640"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#acd9d029906e9ca7ca590bf6766de6368">00640</a> <span class="keywordtype">void</span> <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#acd9d029906e9ca7ca590bf6766de6368" title="receive transferred over DMA">dma1_channel2_isr</a>(<span class="keywordtype">void</span>)
<a name="l00641"></a>00641 {
<a name="l00642"></a>00642   <span class="keyword">struct </span><a class="code" href="structspi__transaction.html" title="SPI transaction structure.">spi_transaction</a> *trans = <a class="code" href="group__spi.html#gaedccba8390a9d630d522a0b282c4f9b9">spi1</a>.<a class="code" href="structspi__periph.html#a5f319ec82695509b414649937a379da6">trans</a>[<a class="code" href="group__spi.html#gaedccba8390a9d630d522a0b282c4f9b9">spi1</a>.<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a>];
<a name="l00643"></a>00643   <span class="keywordflow">if</span> ( trans-&gt;<a class="code" href="structspi__transaction.html#a2716d9d8e12e4b02d9093bfbe01346ba">select</a> == <a class="code" href="group__spi.html#gga7a54d65ebae5c91cb0b5f28cd7111ae3aba395831c171e283b2479f63db99d00c">SPISelectUnselect</a> || trans-&gt;<a class="code" href="structspi__transaction.html#a2716d9d8e12e4b02d9093bfbe01346ba">select</a> == <a class="code" href="group__spi.html#gga7a54d65ebae5c91cb0b5f28cd7111ae3acfd3336d9cd80d7a1b9eb7582848def5">SPIUnselect</a> ) {
<a name="l00644"></a>00644     <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#af3a0a783f898c0211f2c0e5498c746a0">SpiSlaveUnselect</a>( trans-&gt;<a class="code" href="structspi__transaction.html#ad172d82768bb46939cb4e6ffbd230e77">slave_idx</a> );
<a name="l00645"></a>00645   }
<a name="l00646"></a>00646 
<a name="l00647"></a>00647   <span class="keywordflow">if</span> ((DMA1_ISR &amp; DMA_ISR_TCIF2) != 0) {
<a name="l00648"></a>00648     <span class="comment">// clear int pending bit</span>
<a name="l00649"></a>00649     DMA1_IFCR |= DMA_IFCR_CTCIF2;
<a name="l00650"></a>00650 
<a name="l00651"></a>00651     <span class="comment">// mark as available</span>
<a name="l00652"></a>00652     <span class="comment">// FIXME: should only be needed in slave mode...</span>
<a name="l00653"></a>00653     <span class="comment">//spi_message_received = TRUE;</span>
<a name="l00654"></a>00654   }
<a name="l00655"></a>00655   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a0691bd5fba1792e012d73c002cb44a95" title="Processing done after rx completes.">process_rx_dma_interrupt</a>( &amp;<a class="code" href="group__spi.html#gaedccba8390a9d630d522a0b282c4f9b9">spi1</a> );
<a name="l00656"></a>00656 }
<a name="l00657"></a>00657 
<a name="l00659"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a6abe8340eace6d5c19e4f722cd290a0a">00659</a> <span class="keywordtype">void</span> <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a6abe8340eace6d5c19e4f722cd290a0a" title="transmit transferred over DMA">dma1_channel3_isr</a>(<span class="keywordtype">void</span>)
<a name="l00660"></a>00660 {
<a name="l00661"></a>00661   <span class="keyword">struct </span><a class="code" href="structspi__transaction.html" title="SPI transaction structure.">spi_transaction</a> *trans = <a class="code" href="group__spi.html#gaedccba8390a9d630d522a0b282c4f9b9">spi1</a>.<a class="code" href="structspi__periph.html#a5f319ec82695509b414649937a379da6">trans</a>[<a class="code" href="group__spi.html#gaedccba8390a9d630d522a0b282c4f9b9">spi1</a>.<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a>];
<a name="l00662"></a>00662   <span class="keywordflow">if</span> ( trans-&gt;<a class="code" href="structspi__transaction.html#a5d8b23bac2976e4245ac19747a122e71">input_length</a> == 0 ) {
<a name="l00663"></a>00663     <span class="keywordflow">if</span> ( trans-&gt;<a class="code" href="structspi__transaction.html#a2716d9d8e12e4b02d9093bfbe01346ba">select</a> == <a class="code" href="group__spi.html#gga7a54d65ebae5c91cb0b5f28cd7111ae3aba395831c171e283b2479f63db99d00c">SPISelectUnselect</a> || trans-&gt;<a class="code" href="structspi__transaction.html#a2716d9d8e12e4b02d9093bfbe01346ba">select</a> == <a class="code" href="group__spi.html#gga7a54d65ebae5c91cb0b5f28cd7111ae3acfd3336d9cd80d7a1b9eb7582848def5">SPIUnselect</a> ) {
<a name="l00664"></a>00664       <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#af3a0a783f898c0211f2c0e5498c746a0">SpiSlaveUnselect</a>( trans-&gt;<a class="code" href="structspi__transaction.html#ad172d82768bb46939cb4e6ffbd230e77">slave_idx</a> );
<a name="l00665"></a>00665     }
<a name="l00666"></a>00666   }
<a name="l00667"></a>00667 
<a name="l00668"></a>00668   <span class="keywordflow">if</span> ((DMA1_ISR &amp; DMA_ISR_TCIF3) != 0) {
<a name="l00669"></a>00669     <span class="comment">// clear int pending bit</span>
<a name="l00670"></a>00670     DMA1_IFCR |= DMA_IFCR_CTCIF3;
<a name="l00671"></a>00671 
<a name="l00672"></a>00672     <span class="comment">// mark as available</span>
<a name="l00673"></a>00673     <span class="comment">// FIXME: should only be needed in slave mode...</span>
<a name="l00674"></a>00674     <span class="comment">//spi_message_received = TRUE;</span>
<a name="l00675"></a>00675   }
<a name="l00676"></a>00676   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a28927664346f77a7fc1aeb8994b7869c" title="Processing done after tx completes.">process_tx_dma_interrupt</a>( &amp;<a class="code" href="group__spi.html#gaedccba8390a9d630d522a0b282c4f9b9">spi1</a> );
<a name="l00677"></a>00677 }
<a name="l00678"></a>00678 
<a name="l00679"></a>00679 <span class="preprocessor">#endif</span>
<a name="l00680"></a>00680 <span class="preprocessor"></span>
<a name="l00681"></a>00681 <span class="preprocessor">#ifdef USE_SPI2</span>
<a name="l00682"></a>00682 <span class="preprocessor"></span>
<a name="l00683"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#ac13fd4f156b4a88afac6d174103a88a8">00683</a> <span class="keywordtype">void</span> <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#ac13fd4f156b4a88afac6d174103a88a8" title="receive transferred over DMA">dma1_channel4_isr</a>(<span class="keywordtype">void</span>)
<a name="l00684"></a>00684 {
<a name="l00685"></a>00685   <span class="keyword">struct </span><a class="code" href="structspi__transaction.html" title="SPI transaction structure.">spi_transaction</a> *trans = <a class="code" href="group__spi.html#gabc3004247e95c09c15cfdf7d3e6402b7">spi2</a>.<a class="code" href="structspi__periph.html#a5f319ec82695509b414649937a379da6">trans</a>[<a class="code" href="group__spi.html#gabc3004247e95c09c15cfdf7d3e6402b7">spi2</a>.<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a>];
<a name="l00686"></a>00686   <span class="keywordflow">if</span> ( trans-&gt;<a class="code" href="structspi__transaction.html#a2716d9d8e12e4b02d9093bfbe01346ba">select</a> == <a class="code" href="group__spi.html#gga7a54d65ebae5c91cb0b5f28cd7111ae3aba395831c171e283b2479f63db99d00c">SPISelectUnselect</a> || trans-&gt;<a class="code" href="structspi__transaction.html#a2716d9d8e12e4b02d9093bfbe01346ba">select</a> == <a class="code" href="group__spi.html#gga7a54d65ebae5c91cb0b5f28cd7111ae3acfd3336d9cd80d7a1b9eb7582848def5">SPIUnselect</a> ) {
<a name="l00687"></a>00687     <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#af3a0a783f898c0211f2c0e5498c746a0">SpiSlaveUnselect</a>( trans-&gt;<a class="code" href="structspi__transaction.html#ad172d82768bb46939cb4e6ffbd230e77">slave_idx</a> );
<a name="l00688"></a>00688   }
<a name="l00689"></a>00689 
<a name="l00690"></a>00690   <span class="keywordflow">if</span> ((DMA1_ISR &amp; DMA_ISR_TCIF4) != 0) {
<a name="l00691"></a>00691     <span class="comment">// clear int pending bit</span>
<a name="l00692"></a>00692     DMA1_IFCR |= DMA_IFCR_CTCIF4;
<a name="l00693"></a>00693 
<a name="l00694"></a>00694     <span class="comment">// mark as available</span>
<a name="l00695"></a>00695     <span class="comment">// FIXME: should only be needed in slave mode...</span>
<a name="l00696"></a>00696     <span class="comment">//spi_message_received = TRUE;</span>
<a name="l00697"></a>00697   }
<a name="l00698"></a>00698   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a0691bd5fba1792e012d73c002cb44a95" title="Processing done after rx completes.">process_rx_dma_interrupt</a>( &amp;<a class="code" href="group__spi.html#gabc3004247e95c09c15cfdf7d3e6402b7">spi2</a> );
<a name="l00699"></a>00699 }
<a name="l00700"></a>00700 
<a name="l00702"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#ad26a5c303d0c6a60f586099c85109e9d">00702</a> <span class="keywordtype">void</span> <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#ad26a5c303d0c6a60f586099c85109e9d" title="transmit transferred over DMA">dma1_channel5_isr</a>(<span class="keywordtype">void</span>)
<a name="l00703"></a>00703 {
<a name="l00704"></a>00704   <span class="keyword">struct </span><a class="code" href="structspi__transaction.html" title="SPI transaction structure.">spi_transaction</a> *trans = <a class="code" href="group__spi.html#gabc3004247e95c09c15cfdf7d3e6402b7">spi2</a>.<a class="code" href="structspi__periph.html#a5f319ec82695509b414649937a379da6">trans</a>[<a class="code" href="group__spi.html#gabc3004247e95c09c15cfdf7d3e6402b7">spi2</a>.<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a>];
<a name="l00705"></a>00705   <span class="keywordflow">if</span> ( trans-&gt;<a class="code" href="structspi__transaction.html#a5d8b23bac2976e4245ac19747a122e71">input_length</a> == 0 ) {
<a name="l00706"></a>00706     <span class="keywordflow">if</span> ( trans-&gt;<a class="code" href="structspi__transaction.html#a2716d9d8e12e4b02d9093bfbe01346ba">select</a> == <a class="code" href="group__spi.html#gga7a54d65ebae5c91cb0b5f28cd7111ae3aba395831c171e283b2479f63db99d00c">SPISelectUnselect</a> || trans-&gt;<a class="code" href="structspi__transaction.html#a2716d9d8e12e4b02d9093bfbe01346ba">select</a> == <a class="code" href="group__spi.html#gga7a54d65ebae5c91cb0b5f28cd7111ae3acfd3336d9cd80d7a1b9eb7582848def5">SPIUnselect</a> ) {
<a name="l00707"></a>00707       <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#af3a0a783f898c0211f2c0e5498c746a0">SpiSlaveUnselect</a>( trans-&gt;<a class="code" href="structspi__transaction.html#ad172d82768bb46939cb4e6ffbd230e77">slave_idx</a> );
<a name="l00708"></a>00708     }
<a name="l00709"></a>00709   }
<a name="l00710"></a>00710   <span class="keywordflow">if</span> ((DMA1_ISR &amp; DMA_ISR_TCIF5) != 0) {
<a name="l00711"></a>00711     <span class="comment">// clear int pending bit</span>
<a name="l00712"></a>00712     DMA1_IFCR |= DMA_IFCR_CTCIF5;
<a name="l00713"></a>00713 
<a name="l00714"></a>00714     <span class="comment">// mark as available</span>
<a name="l00715"></a>00715     <span class="comment">// FIXME: should only be needed in slave mode...</span>
<a name="l00716"></a>00716     <span class="comment">//spi_message_received = TRUE;</span>
<a name="l00717"></a>00717   }
<a name="l00718"></a>00718   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a28927664346f77a7fc1aeb8994b7869c" title="Processing done after tx completes.">process_tx_dma_interrupt</a>( &amp;<a class="code" href="group__spi.html#gabc3004247e95c09c15cfdf7d3e6402b7">spi2</a> );
<a name="l00719"></a>00719 }
<a name="l00720"></a>00720 
<a name="l00721"></a>00721 <span class="preprocessor">#endif</span>
<a name="l00722"></a>00722 <span class="preprocessor"></span>
<a name="l00723"></a>00723 <span class="preprocessor">#if USE_SPI0</span>
<a name="l00724"></a>00724 <span class="preprocessor"></span>
<a name="l00725"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a2ed33a829d80508c811ad7b38fd1f4a1">00725</a> <span class="keywordtype">void</span> <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a2ed33a829d80508c811ad7b38fd1f4a1" title="receive transferred over DMA">dma2_channel1_isr</a>(<span class="keywordtype">void</span>)
<a name="l00726"></a>00726 {
<a name="l00727"></a>00727   <span class="keyword">struct </span><a class="code" href="structspi__transaction.html" title="SPI transaction structure.">spi_transaction</a> *trans = <a class="code" href="group__spi.html#gae920399b05f855df64dd584fe647eab3">spi0</a>.<a class="code" href="structspi__periph.html#a5f319ec82695509b414649937a379da6">trans</a>[<a class="code" href="group__spi.html#gae920399b05f855df64dd584fe647eab3">spi0</a>.<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a>];
<a name="l00728"></a>00728   <span class="keywordflow">if</span> ( trans-&gt;<a class="code" href="structspi__transaction.html#a2716d9d8e12e4b02d9093bfbe01346ba">select</a> == <a class="code" href="group__spi.html#gga7a54d65ebae5c91cb0b5f28cd7111ae3aba395831c171e283b2479f63db99d00c">SPISelectUnselect</a> || trans-&gt;<a class="code" href="structspi__transaction.html#a2716d9d8e12e4b02d9093bfbe01346ba">select</a> == <a class="code" href="group__spi.html#gga7a54d65ebae5c91cb0b5f28cd7111ae3acfd3336d9cd80d7a1b9eb7582848def5">SPIUnselect</a> ) {
<a name="l00729"></a>00729     <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#af3a0a783f898c0211f2c0e5498c746a0">SpiSlaveUnselect</a>( trans-&gt;<a class="code" href="structspi__transaction.html#ad172d82768bb46939cb4e6ffbd230e77">slave_idx</a> );
<a name="l00730"></a>00730   }
<a name="l00731"></a>00731 
<a name="l00732"></a>00732   <span class="keywordflow">if</span> ((DMA2_ISR &amp; DMA_ISR_TCIF1) != 0) {
<a name="l00733"></a>00733     <span class="comment">// clear int pending bit</span>
<a name="l00734"></a>00734     DMA2_IFCR |= DMA_IFCR_CTCIF1;
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     <span class="comment">// mark as available</span>
<a name="l00737"></a>00737     <span class="comment">// FIXME: should only be needed in slave mode...</span>
<a name="l00738"></a>00738     <span class="comment">//spi_message_received = TRUE;</span>
<a name="l00739"></a>00739   }
<a name="l00740"></a>00740   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a0691bd5fba1792e012d73c002cb44a95" title="Processing done after rx completes.">process_rx_dma_interrupt</a>( &amp;<a class="code" href="group__spi.html#gae920399b05f855df64dd584fe647eab3">spi0</a> );
<a name="l00741"></a>00741 }
<a name="l00742"></a>00742 
<a name="l00744"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a790d44453472c9b63d20f315425b4e37">00744</a> <span class="keywordtype">void</span> <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a790d44453472c9b63d20f315425b4e37" title="transmit transferred over DMA">dma2_channel2_isr</a>(<span class="keywordtype">void</span>)
<a name="l00745"></a>00745 {
<a name="l00746"></a>00746   <span class="keyword">struct </span><a class="code" href="structspi__transaction.html" title="SPI transaction structure.">spi_transaction</a> *trans = <a class="code" href="group__spi.html#gae920399b05f855df64dd584fe647eab3">spi0</a>.<a class="code" href="structspi__periph.html#a5f319ec82695509b414649937a379da6">trans</a>[<a class="code" href="group__spi.html#gae920399b05f855df64dd584fe647eab3">spi0</a>.<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a>];
<a name="l00747"></a>00747   <span class="keywordflow">if</span> ( trans-&gt;<a class="code" href="structspi__transaction.html#a5d8b23bac2976e4245ac19747a122e71">input_length</a> == 0 ) {
<a name="l00748"></a>00748     <span class="keywordflow">if</span> ( trans-&gt;<a class="code" href="structspi__transaction.html#a2716d9d8e12e4b02d9093bfbe01346ba">select</a> == <a class="code" href="group__spi.html#gga7a54d65ebae5c91cb0b5f28cd7111ae3aba395831c171e283b2479f63db99d00c">SPISelectUnselect</a> || trans-&gt;<a class="code" href="structspi__transaction.html#a2716d9d8e12e4b02d9093bfbe01346ba">select</a> == <a class="code" href="group__spi.html#gga7a54d65ebae5c91cb0b5f28cd7111ae3acfd3336d9cd80d7a1b9eb7582848def5">SPIUnselect</a> ) {
<a name="l00749"></a>00749       <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#af3a0a783f898c0211f2c0e5498c746a0">SpiSlaveUnselect</a>( trans-&gt;<a class="code" href="structspi__transaction.html#ad172d82768bb46939cb4e6ffbd230e77">slave_idx</a> );
<a name="l00750"></a>00750     }
<a name="l00751"></a>00751   }
<a name="l00752"></a>00752 
<a name="l00753"></a>00753   <span class="keywordflow">if</span> ((DMA2_ISR &amp; DMA_ISR_TCIF2) != 0) {
<a name="l00754"></a>00754     <span class="comment">// clear int pending bit</span>
<a name="l00755"></a>00755     DMA2_IFCR |= DMA_IFCR_CTCIF2;
<a name="l00756"></a>00756 
<a name="l00757"></a>00757     <span class="comment">// mark as available</span>
<a name="l00758"></a>00758     <span class="comment">// FIXME: should only be needed in slave mode...</span>
<a name="l00759"></a>00759     <span class="comment">//spi_message_received = TRUE;</span>
<a name="l00760"></a>00760   }
<a name="l00761"></a>00761   <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a28927664346f77a7fc1aeb8994b7869c" title="Processing done after tx completes.">process_tx_dma_interrupt</a>( &amp;<a class="code" href="group__spi.html#gae920399b05f855df64dd584fe647eab3">spi0</a> );
<a name="l00762"></a>00762 }
<a name="l00763"></a>00763 
<a name="l00764"></a>00764 <span class="preprocessor">#endif</span>
<a name="l00765"></a>00765 <span class="preprocessor"></span>
<a name="l00767"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a0691bd5fba1792e012d73c002cb44a95">00767</a> <span class="keywordtype">void</span> <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a0691bd5fba1792e012d73c002cb44a95" title="Processing done after rx completes.">process_rx_dma_interrupt</a>( <span class="keyword">struct</span> <a class="code" href="structspi__periph.html">spi_periph</a> *spi ) {
<a name="l00768"></a>00768   <span class="keyword">struct </span><a class="code" href="structspi__periph__dma.html" title="This structure keeps track of specific ID&#39;s for each SPI bus, which allows for more code reuse...">spi_periph_dma</a> *<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a> = spi-&gt;<a class="code" href="structspi__periph.html#a8b32489ec5498094c97fd4d31209ab47">init_struct</a>;
<a name="l00769"></a>00769   <span class="keyword">struct </span><a class="code" href="structspi__transaction.html" title="SPI transaction structure.">spi_transaction</a> *trans = spi-&gt;<a class="code" href="structspi__periph.html#a5f319ec82695509b414649937a379da6">trans</a>[spi-&gt;<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a>];
<a name="l00770"></a>00770 
<a name="l00771"></a>00771   <span class="comment">// disable DMA Channel</span>
<a name="l00772"></a>00772   dma_disable_transfer_complete_interrupt( dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aefcd5ba30da5eaf93f6d3e0a29ee9467">rx_chan</a> );
<a name="l00773"></a>00773 
<a name="l00774"></a>00774   <span class="comment">// Disable SPI Rx and TX request</span>
<a name="l00775"></a>00775   spi_disable_rx_dma( dma-&gt;<a class="code" href="structspi__periph__dma.html#aa38bcf805c46baa4d49f4ace89cfed57">spi</a> );
<a name="l00776"></a>00776 
<a name="l00777"></a>00777   <span class="comment">// Disable DMA1 rx and tx channels</span>
<a name="l00778"></a>00778   dma_disable_channel( dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aefcd5ba30da5eaf93f6d3e0a29ee9467">rx_chan</a> );
<a name="l00779"></a>00779 
<a name="l00780"></a>00780   trans-&gt;<a class="code" href="structspi__transaction.html#afcc49de6913e59398111a070be5aeda2">status</a> = <a class="code" href="group__spi.html#gga52e70c55efc6a9b04903157a0965baacaa4021c68696337695cfdb356866f3b53">SPITransSuccess</a>;
<a name="l00781"></a>00781   <span class="keywordflow">if</span> (trans-&gt;<a class="code" href="structspi__transaction.html#a42f7b32b71120469bf60af28f5880177">after_cb</a> != 0) {
<a name="l00782"></a>00782     trans-&gt;<a class="code" href="structspi__transaction.html#a42f7b32b71120469bf60af28f5880177">after_cb</a>( trans );
<a name="l00783"></a>00783   }
<a name="l00784"></a>00784   spi-&gt;<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a>++;
<a name="l00785"></a>00785 
<a name="l00786"></a>00786   <span class="comment">// Check if there is another pending SPI transaction</span>
<a name="l00787"></a>00787   <span class="keywordflow">if</span> (spi-&gt;<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a> &gt;= SPI_TRANSACTION_QUEUE_LEN)
<a name="l00788"></a>00788     spi-&gt;<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a> = 0;
<a name="l00789"></a>00789   <span class="keywordflow">if</span> (spi-&gt;<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a> == spi-&gt;<a class="code" href="structspi__periph.html#ab96104b648a016e934752e01ec4f2b59">trans_insert_idx</a>  || spi-&gt;<a class="code" href="structspi__periph.html#acd3194574f680b35ece651e784c4327a">suspend</a> )
<a name="l00790"></a>00790     spi-&gt;<a class="code" href="structspi__periph.html#a413be255346b4fefbb01e9a55ee8a286">status</a> = <a class="code" href="group__spi.html#gga495f0019475966e28264aaf8e37c6529a043fd5f30e831835768732e5f373dada">SPIIdle</a>;
<a name="l00791"></a>00791   <span class="keywordflow">else</span>
<a name="l00792"></a>00792     <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#aa2be57519fcaa1b2795cdd27016ff696">spi_rw</a>(spi, spi-&gt;<a class="code" href="structspi__periph.html#a5f319ec82695509b414649937a379da6">trans</a>[spi-&gt;<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a>]);
<a name="l00793"></a>00793 }
<a name="l00794"></a>00794 
<a name="l00796"></a><a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a28927664346f77a7fc1aeb8994b7869c">00796</a> <span class="keywordtype">void</span> <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#a28927664346f77a7fc1aeb8994b7869c" title="Processing done after tx completes.">process_tx_dma_interrupt</a>( <span class="keyword">struct</span> <a class="code" href="structspi__periph.html">spi_periph</a> *spi ) {
<a name="l00797"></a>00797   <span class="keyword">struct </span><a class="code" href="structspi__periph__dma.html" title="This structure keeps track of specific ID&#39;s for each SPI bus, which allows for more code reuse...">spi_periph_dma</a> *<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a> = spi-&gt;<a class="code" href="structspi__periph.html#a8b32489ec5498094c97fd4d31209ab47">init_struct</a>;
<a name="l00798"></a>00798   <span class="keyword">struct </span><a class="code" href="structspi__transaction.html" title="SPI transaction structure.">spi_transaction</a> *trans = spi-&gt;<a class="code" href="structspi__periph.html#a5f319ec82695509b414649937a379da6">trans</a>[spi-&gt;<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a>];
<a name="l00799"></a>00799 
<a name="l00800"></a>00800   <span class="comment">// disable DMA Channel</span>
<a name="l00801"></a>00801   dma_disable_transfer_complete_interrupt( dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aff566f47d98f3f04370908401ad6c47d">tx_chan</a> );
<a name="l00802"></a>00802 
<a name="l00803"></a>00803   <span class="comment">// Disable SPI TX request</span>
<a name="l00804"></a>00804   spi_disable_tx_dma( dma-&gt;<a class="code" href="structspi__periph__dma.html#aa38bcf805c46baa4d49f4ace89cfed57">spi</a> );
<a name="l00805"></a>00805 
<a name="l00806"></a>00806   <span class="comment">// Disable DMA1 tx channel</span>
<a name="l00807"></a>00807   dma_disable_channel( dma-&gt;<a class="code" href="structspi__periph__dma.html#a88d3abbc4fdda60634150611244814fc">dma</a>, dma-&gt;<a class="code" href="structspi__periph__dma.html#aff566f47d98f3f04370908401ad6c47d">tx_chan</a> );
<a name="l00808"></a>00808 
<a name="l00809"></a>00809   <span class="keywordflow">if</span> ( trans-&gt;<a class="code" href="structspi__transaction.html#a5d8b23bac2976e4245ac19747a122e71">input_length</a> == 0 ) {
<a name="l00810"></a>00810     <span class="comment">// this transaction does not require rx</span>
<a name="l00811"></a>00811     trans-&gt;<a class="code" href="structspi__transaction.html#afcc49de6913e59398111a070be5aeda2">status</a> = <a class="code" href="group__spi.html#gga52e70c55efc6a9b04903157a0965baacaa4021c68696337695cfdb356866f3b53">SPITransSuccess</a>;
<a name="l00812"></a>00812     <span class="keywordflow">if</span> (trans-&gt;<a class="code" href="structspi__transaction.html#a42f7b32b71120469bf60af28f5880177">after_cb</a> != 0) {
<a name="l00813"></a>00813       trans-&gt;<a class="code" href="structspi__transaction.html#a42f7b32b71120469bf60af28f5880177">after_cb</a>( trans );
<a name="l00814"></a>00814     }
<a name="l00815"></a>00815     spi-&gt;<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a>++;
<a name="l00816"></a>00816 
<a name="l00817"></a>00817     <span class="comment">// Check if there is another pending SPI transaction</span>
<a name="l00818"></a>00818     <span class="keywordflow">if</span> (spi-&gt;<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a> &gt;= SPI_TRANSACTION_QUEUE_LEN)
<a name="l00819"></a>00819       spi-&gt;<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a> = 0;
<a name="l00820"></a>00820     <span class="keywordflow">if</span> (spi-&gt;<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a> == spi-&gt;<a class="code" href="structspi__periph.html#ab96104b648a016e934752e01ec4f2b59">trans_insert_idx</a>  || spi-&gt;<a class="code" href="structspi__periph.html#acd3194574f680b35ece651e784c4327a">suspend</a>)
<a name="l00821"></a>00821       spi-&gt;<a class="code" href="structspi__periph.html#a413be255346b4fefbb01e9a55ee8a286">status</a> = <a class="code" href="group__spi.html#gga495f0019475966e28264aaf8e37c6529a043fd5f30e831835768732e5f373dada">SPIIdle</a>;
<a name="l00822"></a>00822     <span class="keywordflow">else</span>
<a name="l00823"></a>00823       <a class="code" href="stm32_2mcu__periph_2spi__arch_8c.html#aa2be57519fcaa1b2795cdd27016ff696">spi_rw</a>(spi, spi-&gt;<a class="code" href="structspi__periph.html#a5f319ec82695509b414649937a379da6">trans</a>[spi-&gt;<a class="code" href="structspi__periph.html#af1cd87f1e6b8cf0bfad3ba646224601f">trans_extract_idx</a>]);
<a name="l00824"></a>00824   }
<a name="l00825"></a>00825 }
<a name="l00826"></a>00826 
<a name="l00827"></a>00827 <span class="preprocessor">#endif </span>
<a name="l00830"></a>00830 <span class="preprocessor"></span><span class="comment">/*</span>
<a name="l00831"></a>00831 <span class="comment"> *</span>
<a name="l00832"></a>00832 <span class="comment"> * SPI Slave code</span>
<a name="l00833"></a>00833 <span class="comment"> *</span>
<a name="l00834"></a>00834 <span class="comment"> * FIXME implement it</span>
<a name="l00835"></a>00835 <span class="comment"> *</span>
<a name="l00836"></a>00836 <span class="comment"> */</span>
<a name="l00837"></a>00837 <span class="preprocessor">#ifdef SPI_SLAVE</span>
<a name="l00838"></a>00838 <span class="preprocessor"></span>
<a name="l00839"></a>00839 <span class="preprocessor">#warning SPI_SLAVE mode currently not implemented for STM32.</span>
<a name="l00840"></a>00840 <span class="preprocessor"></span>
<a name="l00841"></a>00841 <span class="preprocessor">#endif </span><span class="comment">/* SPI_SLAVE */</span>
</pre></div></div><!-- contents -->
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="stm32_2mcu__periph_2spi__arch_8c.html">spi_arch.c</a>      </li>

    <li class="footer">Generated on Tue Jan 8 2013 04:00:10 for Paparazzi UAS by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.6.1 </li>
   </ul>
 </div>


</body>
</html>
